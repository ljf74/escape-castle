<!doctype html><meta name=viewport content="width=1200,initial-scale=1"><meta name=apple-mobile-web-app-capable content=yes><meta name=mobile-web-app-capable content=yes><title>CASTLE ESCAPE</title><link rel=icon href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text x=%2230%22 y=%2280%22 font-size=%2280%22>🏰</text><text x=%22-20%22 y=%2275%22 font-size=%2270%22>🏃‍♂️</text></svg>">

<div id=v>
  <div id=camera>
    <div id=scene style=transform:translateZ(100px)rotateX(90deg)></div>
  </div>
  <div id=inventory style=opacity:0;display:none></div>
  <div id=mute onclick=stop() style=opacity:0>🔇</div>
  <div id=text></div>
  <div id=note class=h onclick="innerHTML='',className='h'"></div>
  <div id=bookcover class=h onclick="book.className=innerHTML='',className='h';sound(paper)"></div>
  <div id=book class=h onclick="innerHTML='',className='h'"></div>
  <div id=fo style=opacity:0>
  
  
<script>

// Globals:
// v = viewport, camera, scene, inventory, mute, text, note, bookcover, book, fo
// C, s, i
// helpers (use(), add_inv(), rem_inv() to, txt() )
// tower, room()
// roomXY()
// roomXYp()
// roomXYc()
// rXY[a-z]()
// rxy[1-9]
// svgs
// sounds
// title, ng, cd, bs()
// acs, muted
// invisible css class names: brick ...

// Mangled:
// v, ca, sc, y, m, text, note, bc, book, fo
// C, s, i
// use, ai, ri, to, txt
// tw, room
// ...
// svg => s[1-28]
// sound fx => f[1-12]
// moonstr: ms

// Inventory

for(i=0;i<12;i++)inventory.innerHTML+=`<div id=i${i} onclick=use(${i})>`;

// CSS3DFramework
// ==============

C = {
  P: 0,
  o: {},
  $: t => self[t],

  // inialize an object's properties
  i: t => {
    t.css||(t.css=""),
    t.on=`txt\`${t.on!=null?t.on:t.css}\``;
    if(t.cl && t.cl.startsWith("room")){
      t.cl=t.cl?`onclick=if(!animation){fadeout(),setTimeout(()=&gt;{${t.cl}();fadein()},500);sound(step);setTimeout("sound(step)",300);setTimeout("sound(step)",600)}`:"";
    }
    else {
      t.cl=t.cl?`onclick=if(!animation)${t.cl}()`:"";
    }
    t.html||(t.html=""),
    t.g||(t.g="scene"),
    t.o||(t.o="center center"),
    t.w||(t.w=0),
    t.h||(t.h=0),
    t.x||(t.x=0),
    t.y||(t.y=0),
    t.z||(t.z=0),
    t.rx||(t.rx=0),
    t.ry||(t.ry=0),
    t.rz||(t.rz=0),
    t.sx||(t.sx=1),
    t.sy||(t.sy=1),
    C.o[t.n]=t
  },

  // group of objects
  g: t => { 
    t.d||t.d===0||(t.d=t.h),
    C.i(t),
    C.$(t.g).innerHTML+=`<div id="${t.n}"class="g ${t.css}"style="position:absolute;width:${t.w}px;height:${t.d}px;transform:${C.tr(t)}">`
  },

  // p
  p: t => {
    t.n||(t.n=`p${C.P++}`),
    C.i(t),
    C.$(t.g).insertAdjacentHTML("beforeEnd",`<div id="${t.n}"class="p ${t.css}"style="position:absolute;width:${t.w}px;height:${t.h}px;background:${t.b};transform-origin:${t.o};transform:${C.tr(t)}"onmouseover="${t.on||''}"${t.cl}>${t.html}`)
  },

  // move an object
  m: (t,r) => {
    if(t.n){
      r=C.$(t.n),
      n=C.o[t.n];
      (t.x)&&(n.x=t.x),
      (t.y)&&(n.y=t.y),
      (t.z)&&(n.z=t.z),
      (t.rx)&&(n.rx=t.rx),
      (t.ry)&&(n.ry=t.ry),
      (t.rz)&&(n.rz=t.rz),
      (t.sx)&&(n.sx=t.sx),
      (t.sy)&&(n.sx=t.sy),
      C.o[t.n]=n,
      r.style.transform=C.tr(n)
    }
  },

  // CSS3D transform string
  tr: t => `translateX(-50%)translateY(-50%)translateX(${t.x}px)translateY(${t.y}px)translateZ(${t.z}px)rotateX(${t.rx}deg)rotateY(${t.ry}deg)rotateZ(${t.rz}deg)scaleX(${t.sx})scaleY(${t.sy})`

}

// Helpers
// =======

// clicks
onclick = () => { if(self.s){s.clicks++;} };

// save
save = () => { localStorage.castleescape = JSON.stringify(s) }

fadeout = () => { fo.style.opacity = 1; }
fadein = () => { fo.style.opacity = 0; }

// Inventory
using = -1; // using an inventory item
usingstr = ""; // using an inventory item (string)

add_inv = n => {
  sound(nudge);
  //if(!s.inv.includes(n) || n == "gear"){
    s.inv.push(n);
  //}
  draw_inv();
}

rem_inv = n => {
  sound(nudge);
  if(n == "gear"){
    s.inv.splice(using,1);
  }
  else {
    use(n);
    s.inv = s.inv.filter(i => i != n);
  }
  draw_inv();
  ;
}

draw_inv = () => {
  for(i = 0; i < 12; i++){
    self["i"+i].innerHTML = "";
    if(s.inv[i] == "hanger"){
      C.p({g:"i"+i,x:10,y:20,html:svghanger,css:"hanger",on:"",sx:2,sy:2});
    }
    else if(s.inv[i] == "telescope"){
      C.p({g:"i"+i,x:20,y:35,html:"🔭",css:"telescope",on:""});
    }
    else if(s.inv[i] == "torch"){
      C.p({g:"i"+i,x:40,y:15,w:40,h:30,html:svgtorch,css:"torch",on:""});
    }
    else if(s.inv[i] == "lit torch"){
      C.p({g:"i"+i,x:40,y:15,w:40,h:30,html:svgtorch,css:"lit torch",on:""});
      C.p({g:"i"+i,x:50,y:25,z:2,w:30,h:30,html:"🔥",css:"fire",on:"",sx:.5,sy:.5});
    }
    else { // hammer ... key
      C.p({g:"i"+i,x:40,y:45,w:40,h:30,html:{hammer:"🔨",wood:"🪵",cannonball:"⬤",mouse:"🐁",soup:"🍲","hot soup":"🍲",crown:"👑",gear:"⚙️",cheese:"🧀",wand:"🪄",sword:"🗡️",key:"🔑"}[s.inv[i]],css:s.inv[i],on:""});
    }
  }
}

use = n => {
  
  
  if(using == n && n > -1){
    text.innerHTML = usingstr = "";
    using = -1;
    self["i"+n].style.background = "";
  }
  else {
    text.innerHTML = usingstr = "";
    using = -1;
    for(i = 0; i < 12; i++){
      self["i"+i].style.background="";
    }
    if(s.inv[n]){
      self["i"+n].style.background="#fff";
      text.innerHTML = usingstr = `use ${s.inv[n]} with `;
      using = n;
    }
    else {
      text.innerHTML = "";
    }
  }
}

// Text
lasttxt="";
to=0;
txt = (s = [""]) => {
  if(s.length && s != "c"){
    if(using > -1 && !["up","right","down","left"].includes(s[0])) {text.innerHTML = usingstr + s;}
    else {text.innerHTML = s; }
    clearTimeout(to);
    to=setTimeout(`if(using==-1)text.innerHTML=""`, 2000);
  }
}


// Render stuff
// ============


// Left window
windowleft = (bars,tower) => {
  C.p({x:-280,y:-95+92,z:-50,w:100,h:100,html:(s.r40c > 60 && s.r40c < 300) ? svgwindownight : svgwindow,css:"window",ry:tower?10:0});
  if(bars) C.p({x:-300-25,y:-95+42,z:-40,html:svgbars,css:"bars",on:""});
}

windowright = (bars,tower,cl='') => {
  C.p({x:300-70,y:-95+92,z:-50,w:100,h:100,html:(s.r40c > 60 && s.r40c < 300) ? svgwindownight : svgwindow,css:"window",sx:-1,ry:tower?-10:0,cl});
  if(bars) C.p({x:278,y:-55,z:-40,html:svgbars,css:"bars",on:"",sx:-1});
}

draw_sky = (leftwindow,rightwindow,hay,ctx) => {
  
  // r40d = sky angle
  // r40c = sky angle 0-360 (300 = sun left, 60 = sun right)
  C.g({n:"skygroup",x:0,y:200,rz:s.r40d});
  C.p({g:"skygroup",x:0,y:-600,z:-100,w:400,h:400,b:"radial-gradient(#ffb 5%,#fff0 50%)",css:"sun"});
  C.p({g:"skygroup",x:0,y:600,z:-100,w:100,h:100,html:"🌘",css:"moon",n:"moon"});
  update_sky();
  C.p({x:0,y:0,z:10,w:700,h:500,b:"#f000",css:"sunwrapper",html:"<canvas id=sun width=700 height=500>"});
  ctx=sun.getContext("2d");
  ctx.fillStyle = "#ffb3";
  ctx.beginPath();
  
  if(leftwindow && s.r40c == 300){
    ctx.moveTo(72,285);
    ctx.lineTo(172,470);
    ctx.lineTo(292,470);
    ctx.lineTo(92,230);
  }
  else if(hay && rightwindow && s.r40c == 60 && s.r21b && !s.r21g){
    ctx.moveTo(675-65,285);
    ctx.lineTo(675-115,380);
    ctx.lineTo(675-185,240);
    ctx.lineTo(675-90,222);
    ctx.closePath();
    ctx.fill();
    ctx.fillStyle = "#fb99";
    ctx.beginPath();
    ctx.moveTo(675-270,385);
    ctx.lineTo(675-320,435);
    ctx.lineTo(675-340,385);
    ctx.lineTo(675-280,375);
  }
  else if(rightwindow && s.r40c == 60){
    ctx.moveTo(675-65,285);
    ctx.lineTo(675-175,470);
    ctx.lineTo(675-315,470);
    ctx.lineTo(675-90,222);
  }
  ctx.closePath();
  ctx.fill();
}

wallside = (left,offset,skytop,kitchen,i,j,dx) => {
  if(kitchen){
    C.g({n:"wall", x:left?-427:offset?370:320,y:-65+(skytop?110:0),z:left?-88:-40,ry:left ? 65 : 120,cl:"r33i",css:"wall"});
  }
  else {
    C.g({n:"wall", x:left?-427:offset?370:320,y:-65+(skytop?110:0),z:left?-88:-40,ry:left ? 65 : 120});
  }
  for(i = 0; i < 3; i++){
    for(j = 11; j--;){
      
        dx = (j%2) ? 6:0;
        C.p({g:"wall",x:i*12+dx,y:j*50-200,z:50,w:102,h:52,b:`hsl(50 0% ${50-i*5}%)`,css:"brick"});
    }
  }
}

// Tower top/bottom
tower = (top,i,j,x,y,z,w,dx,ry) => {
  use(-1);
  scene.className = "";
  scene.innerHTML=text.innerHTML=note.innerHTML=book.innerHTML="";
  note.className=book.className="h";
  setTimeout("scene.className='t'",200);
  for(i = 0; i < 8; i++){
    for(j = 15; j--;){
      if(((top && j > 1) || !top) && ((top && !(j==2 && i % 2)) || !top) && !(!(j % 2) && i == 7)){
        
        // Back
        dx = 0;
        w = 104;
        if(j % 2){
          dx = 55;
          if((i == 0)) { w = 50; dx = 30 }
          if((i == 7)) { w = 50; dx = 80 }
        }
        x = i*98 - 300 - dx + Math.random()+(i>4?2:0);
        ry = -(x+10)/22;
        z = -(Math.cos(x/320) * 90);
        C.p({x,y:j*48-300 + Math.random(),w,h:50,b:`hsl(50 0% ${30-z/3}%)`,ry,z,css:"brick"});
      
        // front
        if(j>(top ? 3 : 2) && j < 11){
          
          // left
          if(i == 0){
            w = 35 + ((j%2) ? 10 : 0);
            x = i*98 - 300 - 36 + Math.random()*4+ ((j%2) ? 5 : 0);
            ry = (x+10)/22;
            z = (Math.cos(x/300) * 90)-50;
            C.p({x,y:j*51-302 + Math.random()-8,w,h:52,b:`hsl(50 0% 70%)`,ry,z,css:"brick"});
          }
          
          // right
          if(i == (j%2 ? 7 : 6)){
            w = 35 + ((j%2) ? 10 : 0);
            x = i*98 - 300 - 65 + Math.random()*4 + ((j%2) ? -5 : 100);
            ry = (x+10)/22;
            z = (Math.cos(x/300) * 90)-50;
            C.p({x,y:j*51-302 + Math.random()-8,w,h:52,b:`hsl(50 0% 70%)`,ry,z,css:"brick"});
          }
        }
        
        // top, bottom
        else {
          dx = 0;
          w = 102;
          if(j % 2){
            dx = 47;
            if(i == 0) { w = 50; dx = 22 }
            if((i == 7)) { w = 50; dx = 75 }
          }
          if(i > 3) { dx -=2 }
          x = i*98 - 300 - dx + Math.random();
          ry = (x+10)/22;
          z = (Math.cos(x/300) * 90)-45;
          C.p({x,y:j*50-300 + Math.random()-5,w,h:52,b:`hsl(50 0% ${70+z/4}%)`,ry,z,css:"brick"});
        }
      }
    }
  }
}

// Room (sky on left / right / top, tower on top or not)
room = (skyleft, skyright, skytop, tower,half,i,j,x,y,z,w,dx,ry,no) => {
  use(-1);
  scene.className = "";
  scene.innerHTML=text.innerHTML=note.innerHTML=book.innerHTML="";
  note.className=book.className="h";
  setTimeout("scene.className='t'",200);
  for(i = 0; i < 12; i++){
    for(j = 13; j--;){
      
      // tower
      if(skytop && tower && i < 8 && j < 4) {
        dx = 0;
        w = 102;
        no = 0; if(j % 2){
          dx = 47;
          if(i == 0) { w = 50; dx = 22 }
          if((i == 7)) { w = 50; dx = 75 }
        }
        else{
          if(i == 7) no = 1;
        }
        x = i*98 - 300 - dx + Math.random();
        ry = (x+10)/22;
        z = (Math.cos(x/300) * 90)-145;
        if(!no)C.p({x,y:j*50-300 + Math.random()-5,w,h:52,b:`hsl(50 0% ${90+z/3}%)`,ry,z,css:"brick"});
      }
      
      // Back & front
      if((skytop && (j > 2 || (j == 2 && (i%2)))) || !skytop){
        dx = 0;
        w = 104;
        if((j % 2)){
          dx = 50;
        }
        x = i*98 - 500 + Math.random()*2;
        if(skyleft){
          if(i == 0) continue;
          if(i == 1 && (j%2)){
            w = 52;
            dx -= 25;
          }
        }
        
        if(skyright){
          if(i == 11 || (i == 10 && !(j%2))) continue;
          if(i == 10 && (j%2)){
            w = 52;
            dx += 25;
          }
        }
        z = -50;
        
        // Back
        if(j>(skytop ? 2 : 0)){
          C.p({x:x-dx,y:j*48-300 + Math.random(),w,h:50,b:`hsl(50 0% ${43}%)`,z,css:"brick"});
        }
        
        // front
        if(((i < 2) || (i > (skyright ? 8 : 9)) || (j < (skytop ? 4 : 2)) || (j > 11))){
          if(j>(skytop ? 3 : 1) && j < 12 && !(j%2) && i == 1 && !skyleft) continue;
          if(j>(skytop ? 4 : 2) && j < 12 && (j%2) && i == 9) continue;
          if(s.r33h && half && j > 1 && j < 12 && i > 8) { continue; }
          if(!s.r33h && half && j > 1 && j < 12 && (j%2) && i ==10) C.p({x:x-dx+25,y:j*48-300 + Math.random(),w:50,h:50,b:`hsl(50 0% ${63}%)`,z:-20,css:"brick"});
          else C.p({x:x-dx,y:j*48-300 + Math.random(),w,h:50,b:`hsl(50 0% ${63}%)`,z:-20,css:"brick"});
        }
      }
      
      
    }
  }
}

// Mountains bg
mount = () => {
  C.p({x:0,y:450,z:-600,w:3500,h:800,b:"radial-gradient(#582,#9c6)",css:"mount",on:""});
}

// ======================================
// Room 0-0, start cell
room00 = () => {
  setTimeout("scene.className='t'",200);
  tower(1);
  C.p({x:-5,y:-130,z:-20,w:690,h:70,b:"linear-gradient(#333,#555)",rx:105,css:"c"});
  C.p({x:-5,y:225,z:-30,w:690,h:70,b:"linear-gradient(#333,#555)",rx:60,css:"c"});
  C.p({x:-95,y:135,z:-80,html:svgdoor,w:60,h:100,css:"door",sx:1.8,sy:1.8,ry:5});
  C.p({x:-100,y:80,z:-40,html:"⬇️",css:"arrow",on:"down",cl:"room01",ry:5,sx:1.2,sy:1.2});
  if(!s.r00d) C.p({x:145,y:-40,z:-45,w:20,h:15,html:svghanger,css:"hanger",n:"r002",cl:"r00c"});
  if(s.r00f){
    C.p({x:-105,y:120,z:20,html:"🔒",css:"lock",rz:-2,cl:"r00e",n:"r003",x:-120,y:200,rz:-80});
    C.p({x:-120,y:140,html:"🚪",css:"door",ry:5,z:-45,n:"r004",o:"100px 0",ry:120,sx:1.1,sy:1.1});
  }
  else {
    C.p({x:-105,y:120,z:20,html:"🔒",css:"lock",rz:-2,cl:"r00e",n:"r003"});
    C.p({x:-147,y:125,z:-35,html:"🚪",css:"door",ry:5,sx:1.1,sy:1.1,n:"r004",o:"100px 100px"}); 
  }
  if(s.r00b>2){C.g({x:120-15,y:-10,z:10,n:"frame",y:140,rx:-80});}
  else{C.g({x:120-15,y:-10,z:-40,n:"frame"});}
  C.p({x:0,y:-10-15,html:"🖼️",css:"frame",rz:2,cl:"r00a",n:"r001",g:"frame"});
  C.p({x:40,y:32-47,html:"️🧔🏻‍♂️",css:"framehead nofont",on:"",rz:2,g:"frame"});
  C.p({x:45,y:14-40,html:"👑️",css:"framecrown",on:"",rz:2,sy:.5,g:"frame"});
  C.p({x:260-15,y:120,html:"🛏️",css:"bed",sx:-1});
  C.p({x:-250-15,y:208-15,z:-50,html:"🕳️",css:"hole",rz:90,ry:10,sy:2,cl:"r00h"});
  if(s.r00k) { C.p({x:-205,y:175,z:50,html:"🧀",css:"cheese",sx:-1,cl:"r00l",n:"r006"}); }
  if(s.r00m) { C.p({x:-180,y:175,z:50,html:"🐁",css:"mouse",cl:"r00n",n:"r005",sx:-.4,sy:.4}); }
  if(!s.r00i) { C.p({x:-340,y:410,z:-100,html:"⚙️",css:"gear",cl:"r00j",n:"r007"}); }
  else if(s.r00i <2) { C.p({x:-165,y:175,z:50,html:"⚙️",css:"gear",cl:"r00j",n:"r007"}); }
  windowleft(1,1);
  draw_sky(1,0);
}

// Tear frame
// s.r00b = 0;// frame tearing attempts
r00a = () => {
  sound(step);
  frame.style.animation="wiggle .5s";
  setTimeout('frame.style.animation=""',600);
  if(!s.r00b) s.r00b = 0;
  s.r00b++;
  if(s.r00b>2){
    r001.onclick="";
    C.m({n:"frame",y:140,rx:-80,z:10});
  }
}

// Take hanger
// s.r00d = 0; // hanger removed
r00c = () => {
  add_inv("hanger");
  r002.remove();
  s.r00d = 1;
}

// Use hanger on lock
// r00f = 0; // lock/door open
r00e = () => {
  if(usingstr == "use hanger with "){
    sound(lock);
    sound(dooropen);
    C.m({n:"r003",x:-120,y:200,rz:-80});
    C.m({n:"r004",x:-120,y:140,z:-45,ry:120}); // door
    rem_inv("hanger");
    s.r00f = 1;
  }
}

// put mouse / cheese
r00h = () => {
  if(usingstr == "use mouse with " && (s.r00i != 1)){
    s.r00m = 1;
    C.p({x:-180,y:175,z:50,html:"🐁",css:"mouse",cl:"r00n",n:"r005",sx:.4,sy:.4});
    C.m({n:"r007",y:210});
    use(-1);
    rem_inv("mouse");
    setTimeout(()=> {
      C.m({n:"r005",z:-100,x:-340,y:210});
    },1000);
    setTimeout(()=> {
      C.m({n:"r005",z:50,x:-160,y:175,sx:-.4});
      if(self.r007) C.m({n:"r007",z:50,x:-175,y:175});
      s.r00i = 1;
    },3000);
  }
  else if(usingstr == "use cheese with ") {
    s.r00k = 1;
    C.p({x:-205,y:175,z:50,html:"🧀",css:"cheese",sx:-1,cl:"r00l",n:"r006"});
    use(-1);
    rem_inv("cheese");
    setTimeout(()=>{
      if(!s.inv.includes("mouse")){
        note.innerHTML = "No mouse here... I should try it on another hole";
        note.className = "";
      }
    },1000);
  }
}

// Take gear
// r00i = 0; // 0 = not here, 1: here, 2: taken
r00j = () => {
  r007.remove();
  add_inv("gear");
  s.r00i = 2;
}

// Take cheese
// r00k = 0;  // 0 = not here
r00l = () => {
  r006.remove();
  add_inv("cheese");
  s.r00k = 0;
}

// Take mouse
// r00m = 0;  // 0 = not here
r00n = () => {
  r005.remove();
  add_inv("mouse");
  s.r00m = 0;
}


// ======================================
// Room 0-1: cannon

room01 = () => {
  tower(0);
  C.p({x:-5,y:-190,z:-20,w:690,h:70,b:"linear-gradient(#333,#555)",rx:105,css:"c"});
  C.p({x:-5,y:225,z:-30,w:690,h:70,b:"linear-gradient(#333,#555)",rx:60,css:"c"});
  C.p({x:10,y:-50,html:"🛡️",css:"shield",rz:2});
  C.p({x:35,y:-85,html:svgtri,css:"shape",on:"shield",rz:2,sx:.5,sy:.5});
  C.p({x:-160,y:198,w:1000,h:2000,html:svgdoorstair,ry:9,sx:.16,sy:.16});
  if(s.r01a){
    C.p({x:0,y:170,html:"🪵",css:"wood",z:-5});
      C.p({x:355,y:-7,z:0,w:900,h:500,html:svgcannon,css:s.r01b ? "loaded cannon" : "cannon",sx:.27,sy:.27,o:"bottom left",cl:"r01d",n:"r011",rz:-25});
  }
  else {
    C.p({x:348,y:-10,z:0,w:900,h:500,html:svgcannon,css:s.r01b ? "loaded cannon" : "cannon",sx:.27,sy:.27,o:"bottom left",cl:"r01d",n:"r011"});
  }
  C.p({x:-165,y:65,z:40,html:"⬇️",css:"arrow",on:"down",cl:"room02"});
  C.p({x:-207,y:65,z:40,html:"⬆️",css:"arrow",on:"up",cl:"room00"});
  if(s.r01c){
    C.p({x:215,y:175,z:-5,html:"⬤",css:"cannonball",n:"r012",cl:"r01e"});
  }
  else {
    C.p({x:-50,y:s.r01a?125:175,z:-5,html:"⬤",css:"cannonball",n:"r012",cl:"r01e"});
  }
  windowright(0,1);
  draw_sky(0,1);
}

// Use wood with cannon
//r01a = 0;

// Use boulder with cannon
//r01b = 0;

// Shot on wall
//r01c = 0;

// Cannon
r01d = () => {
  if(usingstr == "use wood with "){
    s.r01a = 1;
    C.p({x:0,y:170,html:"🪵",css:"wood",z:-5});
    C.m({n:"r011",rz:-25,y:-7,x:355});
    rem_inv("wood");
    if(!s.r01c)C.m({n:"r012",y:125});
    use(-1);
  }
  else if(usingstr == "use cannonball with "){
    s.r01b = 1;
    rem_inv("cannonball");
    r011.className = "loaded cannon";
    r011.setAttribute("onmouseover","txt`loaded cannon`");
    use(-1);
  }
  if(usingstr == "use lit torch with " && s.r01a && s.r01b){ // in window
    s.r01b = 0;
    r011.className = "cannon";
    r011.setAttribute("onmouseover","txt`cannon`");
    C.m({n:"r012",x:600,y:-130,z:-135});
    use(-1);
    animation = 1;
    sound(cannonfire);
    setTimeout(anim1,500);
  }
  if(usingstr == "use lit torch with " && !s.r01a && s.r01b){ // in wall
    s.r01b = 0;
    s.r01c = 1;
    r011.className = "cannon";
    r011.setAttribute("onmouseover","txt`cannon`");
    C.m({n:"r012",x:235});
    sound(cannonfire);
    setTimeout('C.m({n:"r012",x:215})',510);
    use(-1);
  }
}

// Pick up cannonball shot on wall
r01e = () => {
  add_inv("cannonball");
  r012.remove();
  C.p({x:-50,y:s.r01a?125:175,z:-5,html:"⬤",css:"cannonball",n:"r012",cl:"r01e"});
  s.r01c = 0;
  ;
}

// ======================================
// room 0-2: telescope
room02 = () => {
  room(1,0,1,1)
  C.p({x:25,y:-120,z:-50,w:950,h:50,b:"linear-gradient(#333,#555)",rx:145});
  C.p({x:25,y:235,z:-50,w:950,h:70,b:"linear-gradient(#333,#555)",rx:60});
  wallside(1,0,1);
  if(!s.r02a) C.p({x:190,y:170,w:30,h:30,html:"🔭",css:"telescope",rz:2,sx:-1,n:"r021",cl:"r02b"});
  C.p({x:-50,y:150,w:500,h:1000,z:-20,html:svgdoorstair,sx:.16,sy:.16});
  C.p({x:-45,y:95,z:40,html:"⬆️",css:"arrow",on:"up",cl:"room01"});
  C.p({x:275,y:95,z:40,html:"➡️",css:"arrow",on:"right",cl:"room12"});
  windowleft(0);
  draw_sky(1,0);
}

// Take telescope
//r02a = 0; // taken
r02b = () => {
  add_inv("telescope");
  r021.remove();
  s.r02a = 1;
}

// ======================================
// room 0-3: throne room
room03 = () => {
  note.className = "h";
  room(1,0,0,0);
  mount();
  C.p({x:25,y:-220,z:-50,w:950,h:50,b:"linear-gradient(#333,#555)",rx:145});
  C.p({x:25,y:235,z:-50,w:950,h:70,b:"linear-gradient(#333,#555)",rx:60});
  C.p({x:-90,y:125,w:30,h:30,html:"💺",css:"throne",sx:-1});
  C.p({x:250,y:185,w:30,h:30,html:"🪨",css:"rock",sx:-1});
  if(!s.r03pt) C.p({x:210,y:135,z:-5,w:30,h:30,html:"🗡️",css:"sword",sx:-1,rz:40,rx:-30,cl:"room03p"});
  C.p({x:275,y:95,z:40,html:"➡️",css:"arrow",on:"right",cl:"room13"});
  wallside(1,0);
  draw_sky(0,0);
}

// Sword puzzle
room03p = () => {
  use(-1);
  r03pm = "";
  room(1,0,0,0);
  C.p({x:25,y:0,z:50,w:950,h:650,b:"linear-gradient(#333,#555)"});
  C.p({x:-170,y:30,z:70,html:"🪨",css:"rock",sx:-1,sx:2,sy:2});
  C.p({x:50,y:55,z:50,w:30,h:30,html:"🗡️",css:"sword2",on:"pull sword",sx:-1,rz:54,rx:-50,n:"r03p1",cl:"r03pp"});
  C.p({x:-360,y:-180,z:80,html:"❌",css:"cross",on:"exit",cl:"room03"});
  C.p({x:-30,y:-180,z:80,html:"⬆️",css:"arrow",on:"up",cl:"r03pu"});
  C.p({x:180,y:0,z:80,html:"➡️",css:"arrow",on:"right",cl:"r03pr"});
  C.p({x:-230,y:0,z:80,html:"⬅️",css:"arrow",on:"left",cl:"r03pl"});
  C.p({x:-30,y:140,z:80,html:"⬇️",css:"arrow",on:"down",cl:"r03pd"});
}

// moves
r03pm = "";

//r03pt = 0; // taken

// pull
r03pp = () => {
  if(r03pm.endsWith("uuddlrlr")) {
    C.m({n:"r03p1",x:80,y:-50,z:200});
    setTimeout(room03,510);
    add_inv("sword");
    sound(sword);
    s.r03pt = 1;
  }
  
  else {
    r03p1.style.animation="wiggle .2s 2";
    setTimeout("r03p1.style.animation=''",510);
  }
}

// move
r03pu = () => {
  sound(sword);
  C.m({n:"r03p1",rx:-30})
  setTimeout("C.m({n:'r03p1',rx:-50})",510);
  r03pm+="u";
}

r03pl = () => {
  sound(sword);
  C.m({n:"r03p1",rz:30})
  setTimeout("C.m({n:'r03p1',rz:55})",510);
  r03pm+="l";
}

r03pr = () => {
  sound(sword);
  C.m({n:"r03p1",rz:70})
  setTimeout("C.m({n:'r03p1',rz:55})",510);
  r03pm+="r";
}

r03pd = () => {
  sound(sword);
  C.m({n:"r03p1",rx:-70})
  setTimeout("C.m({n:'r03p1',rx:-50})",510);
  r03pm+="d";
}



// ======================================
// room 1-2: library

room12 = (i,j,k) => {
  room(0,0,1,0)
  C.p({x:-15,y:-120,z:-50,w:950,h:50,b:"linear-gradient(#333,#555)",rx:145});
  C.p({x:-15,y:235,z:-50,w:950,h:70,b:"linear-gradient(#333,#555)",rx:60});
  C.p({x:-150,y:95,html:"🪜",css:"shelf"});
  for(k of[[0,0],[2,0],[0,1],[1,1],[0,2],[2,2],[1,3],[2,3]]){
    i=k[0],j=k[1];
    C.p({x:i*32-35 + Math.random()*10,y:j*65-30,w:20+Math.random()*2,h:45,b:`hsl(${(i*5+j*15)*20} 50% ${63}%)`,z:20,css:"book",cl:"read book"+i+j});
  }
  C.p({x:235,y:145,w:50,h:100,html:svgdoor,sx:-1.6,sy:1.6});
  C.p({x:275,y:95,z:40,html:"➡️",css:"arrow",on:"right",cl:"room22"});
  C.p({x:-325,y:95,z:40,html:"⬅️",css:"arrow",on:"left",cl:"room02"});
  C.p({x:195,y:165,z:40,html:"⬇️",css:"arrow",on:"down",cl:"room13"});
  draw_sky(0,0);
}

// ======================================
// room 1-3: knight
room13 = () => {
  r13b = 0;
  room(0,0,0,0);
  C.p({x:-25,y:-220,z:-50,w:950,h:50,b:"linear-gradient(#333,#555)",rx:145});
  C.p({x:-25,y:235,z:-50,w:950,h:70,b:"linear-gradient(#333,#555)",rx:60});
  C.p({x:-220,y:105,w:500,h:1000,html:svgknight,css:"knight",sx:.28,sy:.28,cl:"r13a"});
  C.p({x:215,y:140,w:500,h:1000,html:svgdoorstair,sx:-.16,sy:.16});
  C.p({x:275,y:95,z:40,html:"➡️",css:"arrow",on:"right",cl:"room23"});
  C.p({x:-325,y:95,z:40,html:"⬅️",css:"arrow",on:"left",cl:"r13a"});
  C.p({x:175,y:85,z:40,html:"⬆️",css:"arrow",on:"up",cl:"room12"});
  draw_sky(0,0);
}

//r13b = 0; // dialog count
//r13c = 0; // passage open

// Talk to knight
r13a = () => {
  if(s.r13c){
    room03();
    use(-1);
  }
  else if(usingstr == "use crown with " && !s.r13c){
    note.innerHTML = "Welcome, sir !";
    note.className = "";
    setTimeout(room03,2000);
    s.r13c = 1;
    use(-1);
  }
  else {
    note.innerHTML = r13b == 1 ? "(I'm new here,<br>I haven't seen him yet)":"Only the king can enter the throne room!";
    note.className = "";
    r13b++;
  }
}

// ======================================
// Room 2-0: cannonball

room20 = () => {
  tower(1);
  C.p({x:-5,y:-130,z:-20,w:690,h:70,b:"linear-gradient(#333,#555)",rx:105,css:"c"});
  C.p({x:-5,y:225,z:-30,w:690,h:70,b:"linear-gradient(#333,#555)",rx:60,css:"c"});
  if(!s.r20g) C.p({x:130-40,y:50+30,z:5,html:"⬤",css:"cannonball",n:"r201",cl:"r20a"});
  C.p({x:160-40,y:100+30,html:"⬤",css:"cannonball"});
  C.p({x:100-40,y:100+30,html:"⬤",css:"cannonball"});
  C.p({x:190-40,y:150+30,html:"⬤",css:"cannonball"});
  C.p({x:130-40,y:150+30,html:"⬤",css:"cannonball"});
  C.p({x:70-40,y:150+30,html:"⬤",css:"cannonball"});
  if(animation) C.p({x:-300,y:20,html:"⬤",css:"cannonball",n:"r2099",cl:"r20z"});
  C.p({x:-50,y:-20,html:"🛡️",css:"shield",rz:2});
  C.p({x:-20,y:-25,html:"🔴",css:"shape",on:"shield",rz:1});
  if(!s.r20pf) {
    C.p({x:210,y:20,html:"🔒",css:"lock",rz:-2,z:10,cl:"room20p"});
    C.p({x:210,y:-15,html:"🔗",css:"chain",rz:40});
  }
  C.p({x:-85,y:120,w:50,h:100,z:-20,html:svgdoor,ry:5,sx:-1.6,sy:1.6});
  if(!animation) C.p({x:-95,y:65,z:40,html:"⬇️",css:"arrow",on:"down",cl:"room21"})
  windowleft(0,1);
  windowright(s.r20pf ? 0 : 1, 1);
  draw_sky(1,1);
}

// Take boulder
//r20g = 0; // removed

r20a = () => {
  add_inv("cannonball");
  r201.remove();
  s.r20g = 1;
}

// Puzzle

r20pm = [0,0,0,0];
//r20pf = 0; // open

room20p = () => {
  use(-1);
  room(1,0,0,0);
  C.p({x:25,y:0,z:50,w:950,h:650,b:((s.r40c >= 300 || s.r40c < 120) ? "#def":"#002")});
  C.p({x:-360,y:-180,z:80,html:"❌",css:"cross",on:"exit",cl:"room20"});
  C.p({x:-420,y:-220,z:55,html:"🔗",css:"big chain",on:"",sx:1.8,sy:1.8,rz:40});
  C.p({x:-180,y:-240,z:55,html:"🔗",css:"big chain",on:"",sx:1.8,sy:1.8,rz:40});
  C.p({x:20,y:-260,z:51,html:"🔗",css:"big chain",on:"",sx:1.8,sy:1.8,rz:40});
  C.p({x:250,y:-280,z:51,html:"🔗",css:"big chain",on:"",sx:1.8,sy:1.8,rz:40});
  C.p({x:-220,y:-20,z:52,html:"🔒",css:"big lock",on:"",sx:1.8,sy:1.8});
  C.p({x:0,y:-10,z:55,w:50,h:50,b:"#fff",css:"shape shape2",html:[svgsquare,svgstar,svgtri,svgcircle][r20pm[0]],on:"",cl:"r20pa",n:"r20p1"});
  C.p({x:0,y:50,z:55,w:50,h:50,b:"#fff",css:"shape shape2",html:[svgsquare,svgstar,svgtri,svgcircle][r20pm[1]],on:"",cl:"r20pb",n:"r20p2"});
  C.p({x:0,y:110,z:55,w:50,h:50,b:"#fff",css:"shape shape2",html:[svgsquare,svgstar,svgtri,svgcircle][r20pm[2]],on:"",cl:"r20pc",n:"r20p3"});
  C.p({x:0,y:170,z:55,w:50,h:50,b:"#fff",css:"shape shape2",html:[svgsquare,svgstar,svgtri,svgcircle][r20pm[3]],on:"",cl:"r20pd",n:"r20p4"});
}


r20pa = () => {
  r20pm[0] = (r20pm[0]+1) % 4;
  r20pe();
}

r20pb = () => {
  r20pm[1] = (r20pm[1]+1) % 4;
  r20pe();
}

r20pc = () => {
  r20pm[2] = (r20pm[2]+1) % 4;
  r20pe();
}

r20pd = () => {
  r20pm[3] = (r20pm[3]+1) % 4;
  r20pe();
}

r20pe = () => { // draw
  r20p1.innerHTML = [svgsquare,svgstar,svgtri,svgcircle][r20pm[0]];
  r20p2.innerHTML = [svgsquare,svgstar,svgtri,svgcircle][r20pm[1]];
  r20p3.innerHTML = [svgsquare,svgstar,svgtri,svgcircle][r20pm[2]];
  r20p4.innerHTML = [svgsquare,svgstar,svgtri,svgcircle][r20pm[3]];
  if(r20pm.join("") == "3201"){
    sound(lock);
    s.r20pf = 1;
    setTimeout(fadeout, 600);
    setTimeout(room20, 1100);
    setTimeout(fadein, 1200);
  }
}

// ======================================
// Room 2-1: hay (ok)
room21 = () => {
  tower(0)
  C.p({x:-5,y:-190,z:-20,w:690,h:70,b:"linear-gradient(#333,#555)",rx:105,css:"c"});
  C.p({x:-5,y:225,z:-30,w:690,h:70,b:"linear-gradient(#333,#555)",rx:60,css:"c"});
  if(!s.r21g) C.p({x:-40,y:130,z:-20,w:1000,h:1000,html:svghay,on:"hay",sx:.28,sy:.28,cl:"r21a"});
  else if(!s.r21i) {
    // burnt - see gear
    C.p({x:-85,y:210,z:-10,html:"⚙️",css:"gear",cl:"r21h",n:"r007",rx:130});
  }
  C.p({x:-235,y:130,w:500,h:1000,z:-20,html:svgdoorstair,ry:5,sx:.15,sy:.16});
  C.p({x:-185-35,y:70,z:40,html:"⬆️",css:"arrow",on:"up",cl:"room20"});
  C.p({x:-145-37,y:70,z:40,html:"⬇️",css:"arrow",on:"down",cl:"room22"});
  windowright(0,1,"r21a");
  if(s.r21b) { C.p({x:180,y:140,w:30,h:30,html:"🔭",css:"telescope",rz:2,sx:-1,sy:1.1,cl:"egg"}); }
  C.p({x:120,y:-100,z:40,rx:-35,ry:30,html:"🕸️",css:"web"});
  draw_sky(0,1,1);
  if(!s.r21g && s.r21b && s.r40c == 60){
    r21f();
  }
  
}

// Put telescope on window/hay
//r21b = 0;
r21a = () => {
  if(usingstr == "use telescope with "){
    C.p({x:180,y:140,w:30,h:30,html:"🔭",css:"telescope",rz:2,sx:-1,sy:1.1,cl:"egg"});
    s.r21b = 1;
    rem_inv("telescope");
    use(-1);
  }
  if(s.r21b && s.r40c == 60 && !s.r21g){
    setTimeout(fadeout, 1000);
    setTimeout(room21, 1500);
    setTimeout("animation=0;fadein()", 1600);
  }
}

//r21g = 0; // burnt
r21f = () => { // fire
  animation = 1;
  setTimeout(() => {
    C.p({x:0,y:185,z:20,w:30,h:30,html:"🔥",css:"fire"});
    C.p({x:-50,y:175,z:20,w:30,h:30,html:"🔥",css:"fire"});
    C.p({x:-90,y:185,z:20,w:30,h:30,html:"🔥",css:"fire"});
    C.p({x:-30,y:145,z:20,w:30,h:30,html:"🔥",css:"fire"});
    C.p({x:-70,y:125,z:20,w:30,h:30,html:"🔥",css:"fire"});
    C.p({x:-10,y:105,z:20,w:30,h:30,html:"🔥",css:"fire"});
    s.r21g = 1;
    sound(burn);
  },2000);
  setTimeout(fadeout, 5000);
  setTimeout(room21, 6500);
  setTimeout("animation=0;fadein()", 6600);
}

// Take gear
//r21i = 0; // taken
r21h = () => {
  r007.remove();
  s.r21i = 1;
  add_inv("gear");
  ;
}

egg = () => {
  // full moon
  if((s.day % 8) == 4 && s.r40c == 240){
    scene.innerHTML = "";
    C.p({x:-360,y:-180,z:80,html:"❌",css:"cross",on:"exit",cl:"room21"});
    C.p({x:-90,y:70,html:"🌕",sx:2,sy:2});
    C.p({w:640,h:120,x:30,y:-140,z:10,html:"Here's where I'd put an easter egg...<br>If I had any spare bytes!",sx:.5,sy:.5,rz:-10,b:"#853",css:"egg"});
    C.p({w:30,h:140,x:30,y:-112,rz:-10,b:"#853"});
  }
}

// ======================================
// room 2-2: torch

room22 = (i,j) => {
  room(0,0,1,1);
  C.p({x:-15,y:-120,z:-50,w:950,h:50,b:"linear-gradient(#333,#555)",rx:145});
  C.p({x:-15,y:235,z:-50,w:950,h:70,b:"linear-gradient(#333,#555)",rx:60});
  C.p({x:85,y:75,html:"📜",css:"note",sx:1.6,sy:1.6,cl:"r22a"});
  C.p({x:-25,y:85,w:50,h:10,z:10,html:svgtorchsupport,css:"torch holder",sx:1.6,sy:1.6,cl:"r22f"});
  if(!s.r22b) C.p({x:-40,y:45,w:50,h:50,html:svgtorch,on:"torch",sx:1.6,sy:1.6,cl:"r22c",n:"r221"});
  if(!s.r22b && s.r22e){
    C.p({x:-35,y:50,z:20,w:30,h:30,html:"🔥",css:"fire",on:"torch",n:"r222",cl:"r22c"});
  }
  C.p({x:-205,y:140,w:500,h:1000,html:svgdoorstair,sx:.16,sy:.16});
  C.p({x:275,y:95,z:40,html:"➡️",css:"arrow",on:"right",cl:"room32"});
  C.p({x:-325,y:95,z:40,html:"⬅️",css:"arrow",on:"left",cl:"room12"});
  C.p({x:-190,y:85,z:40,html:"⬆️",css:"arrow",on:"up",cl:"r22d"});//"room21"});
  draw_sky(0,0);
}

// Note
r22a = () => {
  note.className="";
  note.innerHTML = "This tower contains flammable material, leave your torch here before going up";
}

// Take/leave torch
//r22b = 0; // torch removed
//r22e = 0; // torch lit

// Put down torch
r22f = () => {
  if(s.inv.includes("lit torch")){
    rem_inv("lit torch");
    s.r22b = 0;
    s.r22e = 1;
    C.p({x:-40,y:45,w:50,h:50,html:svgtorch,on:"torch",sx:1.6,sy:1.6,cl:"r22c",n:"r221"});
    C.p({x:-35,y:50,z:20,w:30,h:30,html:"🔥",css:"fire",on:"torch",n:"r222",cl:"r22c"});
  }
  else if(s.inv.includes("torch")){
    rem_inv("torch");
    s.r22b = 0;
    s.r22e = 0;
    C.p({x:-40,y:45,w:50,h:50,html:svgtorch,on:"torch",sx:1.6,sy:1.6,cl:"r22c",n:"r221"});
  }
  else {
    r22c();
  }
  use(-1);
}

// Take torch
r22c = () => {
  if(s.r22e) {
    add_inv("lit torch");
    r222.remove();
  } else {
    add_inv("torch");
  }
  r221.remove();
  s.r22b = 1;
}

// Go up
r22d = () => {
  if(s.r22b){
    r22a();
  }
  else {
    room21();
  }
}


// ======================================
// room 2-3: exit

room23 = () => {
  room(0,0,0,0);
  C.p({x:-45,y:-220,z:-50,w:950,h:50,b:"linear-gradient(#333,#555)",rx:145});
  C.p({x:-45,y:235,z:-50,w:950,h:70,b:"linear-gradient(#333,#555)",rx:60});
  C.p({x:-75,y:25,z:-10,w:1000,h:1000,html:svgoutside,css:"drawbridge",sx:.4,sy:.43});
  if(s.r23k){
    C.p({x:-200,y:45,z:90,ry:-62,w:600,h:1000,html:svgexit,css:"doors",sx:.4,sy:.4,n:"r231"});
    C.p({x:115,y:45,z:90,ry:95,w:600,h:1000,html:svgexit,css:"doors",sx:-.4,sy:.4,n:"r232"});
  }
  else{
    C.p({x:-150,y:35,w:600,h:1000,html:svgexit,css:"doors",sx:.4,sy:.4,n:"r231",cl:"r23l"});
    C.p({x:10,y:35,w:600,h:1000,html:svgexit,css:"doors",sx:-.4,sy:.4,n:"r232",cl:"r23l"});
    C.p({x:-30,y:110,w:60,h:100,html:svgkeyhole,css:"keyhole",sx:.5,sy:.5,cl:"r23l",n:"r233"});
  }
  C.p({x:150+15,y:80+50,z:-40,w:60,h:100,html:svglever,on:"broken lever",css:"lever",cl:"r23h"});
  C.p({x:155+15,y:-10+30,w:60,h:100,html:svgaxis,on:"gear axis",css:"axis",cl:"r23b"});
  C.p({x:120+15,y:-40+30,z:10,w:60,h:100,html:svgaxis,on:"gear axis",css:"axis",cl:"r23d"});
  C.p({x:155+15,y:-70+30,w:60,h:100,html:svgaxis,on:"gear axis",css:"axis",cl:"r23f"});
  C.p({x:275,y:95,z:30,html:"➡️",css:"arrow",on:"right",cl:"room33"});
  C.p({x:-325,y:95,z:40,html:"⬅️",css:"arrow",on:"left",cl:"room13"});
  if(s.r23a) C.p({x:155-5+15,y:-10+30,html:"⚙️",css:"gear",n:"g1"});
  if(s.r23c) C.p({x:120-4+15,y:-40+30,html:"⚙️",css:"gear",n:"g2"});
  if(s.r23e) C.p({x:155-5+15,y:-70+30,html:"⚙️",css:"gear",n:"g3"});
  if(s.r23g) C.p({x:157+15,y:75,z:-63,html:"🗡️",css:"sword",ry:295,cl:"r23j",n:"r239"});
}

// Put gear 1
//r23a = 0;
r23b = () => {
  if(usingstr == "use gear with " && !s.r23a){
    rem_inv("gear");
    sound(sword);
    use(-1);
    C.p({x:155-5+15,y:-10+30,html:"⚙️",css:"gear",n:"g1",o:"25px -1px"});
    s.r23a = 1;
  }
}

// Put gear 2
//r23c = 0;
r23d = () => {
  if(usingstr == "use gear with " && !s.r23c){
    rem_inv("gear");
    sound(sword);
    use(-1);
    C.p({x:120-4+15,y:-40+30,html:"⚙️",css:"gear",n:"g2",o:"25px -1px"});
    s.r23c = 1;
  }
}

// Put gear 3
//r23e = 0;
r23f = () => {
  if(usingstr == "use gear with " && !s.r23e){
    rem_inv("gear");
    sound(sword);
    use(-1);
    C.p({x:155-5+15,y:-70+30,html:"⚙️",css:"gear",n:"g3",o:"25px -1px"});
    s.r23e = 1;
  }
}

// Put sword
//r23g = 0;
r23h = () => {
  if(usingstr == "use sword with " && !s.r23g){
    rem_inv("sword");
    sound(sword);
    use(-1);
    C.p({x:157+15,y:75,z:-63,html:"🗡️",css:"sword",ry:295,cl:"r23j",n:"r239"});
    s.r23g = 1;
  }
}

// Use sword
//r23i = 0;
r23j = () => {
  if(!s.r23k){
    note.innerHTML = "Open the doors first";
    note.className = "";
  }
  else if(s.r23c && s.r23e && !s.r23g){
    sound(sword);
    C.m({n:"r239",x:182,y:64,rx:-82,ry:270,rz:-25});
    C.m({n:"g1",rz:-45});
    C.m({n:"g2",rz:45});
    C.m({n:"g3",rz:-45});
    s.r23i = 1;
    setTimeout(fadeout, 800);
    setTimeout(room23c, 1300);
    setTimeout(fadein, 1400);
  }
  else {
    note.innerHTML = "Some gears are missing";
    note.className = "";
  }
}


// Use key
//r23k = 0;
r23l = () => {
  if(usingstr == "use key with "){
    sound(dooropen);
    rem_inv("key");
    use(-1);
    r233.remove();
    C.m({n:"r231",x:-200,y:45,z:90,ry:-62});
    C.m({n:"r232",x:115,y:45,z:90,ry:95});
    s.r23k = 1;
  }
}

room23c = () => {
  animation = 1;
  scene.className = scene.innerHTML = text.innerHTML="";
  draw_sky()
  mount();
  C.p({x:0,y:550,z:-500,w:3500,h:400,b:"#7cd",rx:0});
  C.p({x:80,y:260,z:0,w:500,h:100,b:"linear-gradient(#333,#555)",rx:88});
  C.p({x:80,y:-50,z:-30,w:480,h:600,b:"linear-gradient(#a73,#741)",rx:0,o:"bottom center",n:"db"});
  C.p({g:"db",x:14,y:-465,z:0,w:20,h:1000,b:"#222",rx:250,o:"bottom center"});
  C.p({g:"db",x:470,y:-465,z:0,w:20,h:1000,b:"#222",rx:250,o:"bottom center"});
  
  setTimeout("inventory.style.opacity=0;mute.style.opacity=0;C.m({n:'db',rx:90});scene.style.transition='10s all';sound(downbridge,196e3)",1500);
  setTimeout("scene.style.transform='translateZ(1200px)rotateX(15deg)'",5500);
  setTimeout(()=>{
    note.style.left = "175px"
    note.innerHTML = `You're free!<br>Score: ${s.clicks} clicks, ${s.time} seconds<br><a href="//xem.github.io/js13k23/bonus/index.html?${btoa(s.clicks)},${btoa(s.time)}"target=_blank>Share`;
    note.onclick=note.className = "";
    s.end = 1;
  },10500);
}

// ======================================
// room 3-2: anvil fire (ok)
room32 = () => {
  room(0,0,1,0);
  C.p({x:-15,y:-120,z:-50,w:950,h:50,b:"linear-gradient(#333,#555)",rx:145});
  C.p({x:-15,y:235,z:-50,w:950,h:70,b:"linear-gradient(#333,#555)",rx:60});
  if(!s.r32a){
    C.p({x:-130,y:220,w:30,h:30,html:"🔨",css:"hammer",on:"",rz:-45,n:"r323"});
    C.p({x:-125,y:170,z:40,w:20,h:30,on:"???",n:"r321",cl:"r32b"});
  }
  C.p({x:-330+20,y:230,html:"🪵",css:"wood",rz:-90,cl:"r32d"});
  C.p({x:-290+20,y:230,z:10,html:"🪵",css:"wood",rz:-90,cl:"r32d"});
  if(!s.r32c) C.p({x:-310+20,y:200,html:"🪵",css:"wood",rz:-90,n:"r322",cl:"r32d"});
  C.p({x:110-40,y:125,html:"🏦",css:"fireplace",cl:"r32e"});
  C.p({x:160-40+3,y:185,z:20,w:30,h:30,html:"🔥",css:"fire",cl:"r32e"});
  C.p({x:215-40+3,y:185,z:20,w:30,h:30,html:"🔥",css:"fire",cl:"r32e",sx:-1});
  C.p({x:230-40+3,y:185,z:20,w:30,h:30,html:"🔥",css:"fire",cl:"r32e"});
  C.p({x:208-40,y:163,z:10,w:115,h:70,b:"#444",on:"fireplace",cl:"r32e"});
  C.p({x:220-40,y:25,z:-40,w:80,h:300,b:"#555",on:"fireplace",cl:"r32e"});
  C.p({x:-100,y:185,w:100,h:50,html:svganvil,css:"anvil",sx:2,sy:2});
  C.p({x:275,y:95,z:40,html:"➡️",css:"arrow",on:"right",cl:"room42"});
  C.p({x:-325,y:95,z:40,html:"⬅️",css:"arrow",on:"left",cl:"room22"});
  draw_sky(0,0);
}

// Take hammer
//r32a = 0; // hammer removed
r32b = () => {
  add_inv("hammer");
  r321.remove();
  r323.remove();
  s.r32a = 1;
}

// Take wood
//r32c = 0; // wood removed
r32d = () => {
  add_inv("wood");
  r322.remove();
  s.r32c = 1;
}

// Lit torch / heat soup
r32e = () => {
  if(usingstr == "use torch with "){
    sound(miniburn);
    s.inv[using] = "lit torch";
    use(-1);
    draw_inv();
  }
  else if(usingstr == "use soup with "){
    animation = 1;
    rem_inv("soup");
    sound(burn);
    use(-1);
    C.p({x:130,y:150,z:30,html:"🍲",css:"soup",n:"r323",cl:"r32g"});
    C.p({x:130,y:150,z:31,html:"🍲",css:"hot soup o0",on:"hot soup",n:"r324",cl:"r32g"});
    setTimeout("r324.className='p hot soup';r324.setAttribute('onmouseover','txt`hot soup`');animation=0;s.r33b=1",2000);
  }
}

// Take hot soup
//r32f = 0; // removed
r32g = () => {
  add_inv("hot soup");
  r323.remove();
  r324.remove();
  s.r32f = 1;
}


// ======================================
// room 3-3: kitchen
room33 = () => {
  room(0,0,0,0,1)
  C.p({x:25,y:-220,z:-50,w:1050,h:50,b:"linear-gradient(#333,#555)",rx:145});
  C.p({x:25,y:235,z:-50,w:1050,h:70,b:"linear-gradient(#333,#555)",rx:60});
  C.p({x:-60,y:-40,w:100,h:100,html:svgtable,css:"",sx:.3,sy:.3});
  C.p({x:10,y:45,html:"🧑🏻‍🍳",css:"cook",cl:"r33g"});
  if(!s.r33e) C.p({x:-40,y:75,html:"🧀",css:"cheese",cl:"r33f",n:"r332"});
  if(!s.r33c){
    if(s.r33b) C.p({x:130,y:60,html:"🍲",css:"hot soup",n:"r331"});
    else C.p({x:130,y:60,html:"🍲",css:"soup",cl:"r33d",n:"r331"});
  }
  C.p({x:-250,y:-60,html:"🛡️",css:"shield",rz:2});
  C.p({x:-220,y:-65,html:"⭐️",css:"shape",on:"shield",rz:1});
  if(s.r33h){
    C.p({x:325,y:95,z:40,html:"➡️",css:"arrow",on:"right",cl:"room43"});
    C.p({x:495,y:15,z:40,html:svgrock,css:"",sx:-2,sy:2});
    C.p({x:295,y:15,z:40,html:svgrock,css:"",sx:2,sy:2});
    C.p({x:435,y:25,z:40,html:svgrock,css:"",sx:-2,sy:2});
  }
  else { 
    wallside(0,1,0,1);
    C.p({x:400,y:0,z:40,w:120,h:400,on:"wall",cl:"r33i",n:"r334"});
  }
  C.p({x:-325,y:95,z:40,html:"⬅️",css:"arrow",on:"left",cl:"room23"});
}

// soup is hot
//r33b = 0;

// Talk to cook
r33a = () => {
  note.innerHTML = (usingstr == "use hot soup with " || (s.r33b && !s.r33c)) ? "Thanks! You can take the cheese" : "Please help me heat up the soup"
  note.className = "";
}

// Take soup
//r33c = 0; // taken
r33d = () => {
  if(!s.r33b){
    r33a();
    add_inv("soup");
    r331.remove();
    s.r33c = 1;
  }
}

// Take cheese
//r33e = 0; // taken
r33f = () => {
  if(s.r33b && !s.r33c){
    add_inv("cheese");
    r332.remove();
    s.r33e = 1;
  }
  else {
    note.innerHTML = "Please help me heat up the soup first"
    note.className = "";
  }
}

// Put hot soup
r33g = () => {
  if(usingstr == "use hot soup with "){
    C.p({x:130,y:60,html:"🍲",css:"hot soup",cl:"r33c",n:"r331"});
    rem_inv("hot soup");
    s.r33c = 0;
    r33a();
    use(-1);
    draw_inv();
  }
  else r33a();
}

// Break wall
//r33h = 0; // broken
r33i = () => {
  if(usingstr == "use hammer with "){
    sound(cannonfire);
    s.r33h = 1;
    use(-1);
    rem_inv("hammer");
    draw_inv();
    fadeout();
    setTimeout(room33,500);
    setTimeout(fadein,800);
  }
}



// ======================================
// Room 4-0: witch 


room40 = () => {
  tower(1)
  C.p({x:-5,y:-130,z:-20,w:690,h:70,b:"linear-gradient(#333,#555)",rx:105,css:"c"});
  C.p({x:-5,y:225,z:-30,w:690,h:70,b:"linear-gradient(#333,#555)",rx:60,css:"c"});
  C.p({x:80,y:100,w:600,h:1000,html:svgwitch,css:"witch",sx:.25,sy:.25,cl:"r40a"});
  if(s.r40b) C.p({x:190,y:160,w:60,h:100,html:"🪄",css:"wand"});
  C.p({x:80,y:-100,html:"🦇",css:"bat",sy:-1});
  C.p({x:150,y:-95,html:"🦇",css:"bat",sy:-1});
  C.p({x:-30,y:120,w:50,h:100,z:-20,html:svgdoor,ry:0,sx:1.6,sy:1.6});
  C.p({x:-15,y:70,z:40,html:"⬇️",css:"arrow",on:"down",cl:"room41"});
  if(s.r40b) {
    C.p({x:-110,y:50,z:80,html:"↩️",css:"arrow",on:"future",cl:"r40r"});
    C.p({x:-180,y:50,z:80,html:"↪️",css:"arrow",on:"past",cl:"r40l"});
  }
  C.g({n:"wheel",x:-175,y:15,w:150,h:150,on:"time wheel",css:"timewheel",rz:s.r40d});
  C.p({g:"wheel",x:75,y:75,w:150,h:150,b:"#def",css:"c wheel",on:"time wheel"});
  C.p({g:"wheel",html:"🌞",on:"",x:75-15,y:75-65});
  C.p({g:"wheel",html:"🌘",on:"",x:75-15,y:75+30,n:"wheelmoon"});
  C.p({w:158,h:200,x:-175,y:110,b:"linear-gradient(#854,#631)",css:"base",on:"time wheel"});
  draw_sky(0,0);
}

// given wand
//r40b = 0;

// Talk to witch / give wand
r40a = () => {
  phase = s.day%8;
  moonstr = "🌓";
  if(usingstr == "use wand with " || s.r40b){
    s.r40b = 1;
    rem_inv("wand");
    sound(wand);
    note.innerHTML = "You can now turn the wheel of time! Choose the sun and moon's position in the sky..."
    note.className = "";
    C.p({x:190,y:160,w:60,h:100,html:"🪄",css:"wand"});
    C.p({x:-110,y:50,z:80,html:"↩️",css:"arrow",on:"future",cl:"r40r"});
    C.p({x:-180,y:50,z:80,html:"↪️",css:"arrow",on:"past",cl:"r40l"});
    use(-1);
    ;
  }
  
  else if(!s.r40b){
    note.innerHTML = "I am the time witch... I need my wand to power my time machine.<br>I heard they put it in a secret room downstairs, hidden behind a fragile wall..."
    note.className = "";
  }
}

// angle wheel 
//r40c = 300; // adjusted 0-360
//r40d = 300; // real

// current day
//day = 801;

// Prisoners arrived on day 790
// prisoner 2 died on day 796

// Phase of the moon // 🌑 🌒 🌓 🌔 🌕 🌖 🌗 🌘



update_sky = () => {
  //console.log(r40c);
  if(s.r40c == -60) { s.r40c = 360-60; s.day--; phase --;}
  if(s.r40c >= 360) { s.r40c -= 360; s.day++; phase++; }
  phase = s.day % 8;
  moonstr=[..."🌑🌒🌓🌔🌕🌖🌗🌘"][phase];
  if(s.r40c == 240 || s.r40c == 120){ C.m({n:"moon",y:650}) }
  else { C.m({n:"moon",y:600}) }
  if(s.r40c <= 60 || s.r40c > 240) v.style.background = "#cde";
  else v.style.background = "#002";
  C.m({n:"skygroup",rz:s.r40d});
  try { moon.innerHTML = moonstr; wheelmoon.innerHTML = moonstr; }
  catch(e) {}
}

r40r = () => { s.r40c += 60; s.r40d += 60; C.m({n:"wheel",rz:s.r40d}); update_sky(); ; }
r40l = () => { s.r40c -= 60; s.r40d -= 60; C.m({n:"wheel",rz:s.r40d}); update_sky(); ; }


// ======================================
// Room 4-1: wolf

// Prisoners arrived on day 790
// prisoner 2 died / wolf appeared on day 796's night


room41 = () => {
  tower(0);
  C.p({x:-5,y:-190,z:-20,w:690,h:70,b:"linear-gradient(#333,#555)",rx:105,css:"c"});
  C.p({x:-5,y:225,z:-30,w:690,h:70,b:"linear-gradient(#333,#555)",rx:60,css:"c"});
  
  // past before prisoners
  if(s.day <= 790){
    C.p({x:50,y:160,html:"🔗",css:"chain",rz:-45});
    C.p({x:50,y:130,html:"🔗",css:"chain",rz:-45});
    C.p({x:50,y:100,html:"🔗",css:"chain",rz:-45});
    
    C.p({x:50+150,y:160,html:"🔗",css:"chain",rz:-45});
    C.p({x:50+150,y:130,html:"🔗",css:"chain",rz:-45});
    C.p({x:50+150,y:100,html:"🔗",css:"chain",rz:-45});
  }
  
  // past before prisoner 2 dies
  else if(s.day < 796 || (s.day == 796 && s.r40c < 120)){
    C.p({x:80-150,y:130,html:"🧍‍♂️",css:"prisoner",cl:"r41a"});
    C.p({x:190-150,y:120,html:"🔗",css:"chain",rz:20});
    C.p({x:220-150,y:100,html:"🔗",css:"chain",rz:5});
    C.p({x:240-150,y:80,html:"🔗",css:"chain",rz:-35});
    
    C.p({x:80,y:130,html:"🧍‍♂️",css:"prisoner2",on:"prisoner",cl:"r41b"});
    C.p({x:190,y:120,html:"🔗",css:"chain",rz:20});
    C.p({x:220,y:100,html:"🔗",css:"chain",rz:5});
    C.p({x:240,y:80,html:"🔗",css:"chain",rz:-35});
  }
  
  // beast
  else if (s.day >= 790 && (s.day % 8) == 4 && s.r40c < 300 && s.r40c > 60) {
    if(!s.r41v){ C.p({x:-60,y:50,w:1000,h:1000,html:svgwolf,css:"werewolf",sx:.37,sy:.37,cl:"r41c",n:"ww"});
    C.p({x:190-150,y:110,html:"🔗",css:"chain",rz:20});
    C.p({x:220-150,y:100,html:"🔗",css:"chain",rz:5});
    C.p({x:240-150,y:80,html:"🔗",css:"chain",rz:-35});
    }
    else {
      C.p({x:240-150,y:80,html:"🔗",css:"chain",rz:-35});
      C.p({x:240-150,y:100,html:"🔗",css:"chain",rz:-35});
      C.p({x:240-150,y:120,html:"🔗",css:"chain",rz:-35});
    }
    C.p({x:50+150,y:140,html:"🔗",css:"chain"});
    C.p({x:70+150,y:120,html:"🔗",css:"chain"});
    C.p({x:90+150,y:100,html:"🔗",css:"chain"});
    C.p({x:30+150,y:160+20,z:10,html:"💀",css:"skeleton",rz:-30});
    C.p({x:50+150,y:180+20,html:"🦴",css:"skeleton",rz:-30});
    C.p({x:40+150,y:200+20,html:"🦴",css:"skeleton",rz:-60});
    C.p({x:30+150,y:190+20,html:"🦴",css:"skeleton",rz:-90});
  }
  
  // future
  else { //if(s.day > 780) {
    C.p({x:80-150,y:130,html:"🧍‍♂️",css:"prisoner",cl:"r41a"});
    C.p({x:190-150,y:120,html:"🔗",css:"chain",rz:20});
    C.p({x:220-150,y:100,html:"🔗",css:"chain",rz:5});
    C.p({x:240-150,y:80,html:"🔗",css:"chain",rz:-35});
    C.p({x:50+150,y:140,html:"🔗",css:"chain"});
    C.p({x:70+150,y:120,html:"🔗",css:"chain"});
    C.p({x:90+150,y:100,html:"🔗",css:"chain"});
    C.p({x:30+150,y:160+20,z:10,html:"💀",css:"skeleton",rz:-30});
    C.p({x:50+150,y:180+20,html:"🦴",css:"skeleton",rz:-30});
    C.p({x:40+150,y:200+20,html:"🦴",css:"skeleton",rz:-60});
    C.p({x:30+150,y:190+20,html:"🦴",css:"skeleton",rz:-90});
  }

  C.p({x:-110,y:125,w:500,h:1000,z:-20,html:svgdoorstair,ry:5,sx:.16,sy:.16});
  if(animation) { 
    C.p({x:-300,y:20,html:"⬤",css:"cannonball",n:"r2099",cl:"r41z"});
  }
  else {
    if ((s.day % 8) == 4 && s.r40c < 300 && s.r40c > 60 && !s.r41v){
      C.p({x:-110,y:-140,z:40,html:"⬆️",css:"arrow",on:"up",cl:"room40"});
      C.p({x:-70,y:-140,z:40,html:"⬇️",css:"arrow",on:"down",cl:"room42"});
    }
    else{
      C.p({x:-110,y:70,z:40,html:"⬆️",css:"arrow",on:"up",cl:"room40"});
      C.p({x:-70,y:70,z:40,html:"⬇️",css:"arrow",on:"down",cl:"room42"});
    }
  }
  if(s.r41y){
    C.p({x:s.r41v ? -280:55,y:185,html:"⬤",css:"cannonball",n:"r2099",cl:"r41z"});
  }
  C.p({x:-40,y:s.r41w == 1 ? 0 : 400,html:"🔑",css:"key",n:"key",cl:"r41x"});
  windowleft(0,1);
  draw_sky(1,0);
  ;
}

// Talk to prisoner 2
r41a = () => {
  
  // future
  if(s.day > 796 || (s.day == 796 && s.r40c >= 300)) {
    note.innerHTML = "I don't know what happened to my cellmate! We arrived here together last week, and one morning<br>I found him like that!<br>By chance I'm not injured...";
    note.className = "";
  }
  
  // past
  else {
    note.innerHTML = "Release me! I'm innocent ! My stomach hurts!";
    note.className = "";
  }
}

r41b = () => {
  note.innerHTML = "I'm here because I broke the drawbridge lever.<br>I bet it can be replaced by another long object...";
  note.className = "";
}

r41c = () => {
  if(usingstr == "use sword with " || usingstr == "use hammer with "){
    note.innerHTML = "I can't attack it from here, it would kill me first...";
    note.className = "";
    use(-1);
  }
  else {
    note.innerHTML = "AWOOOOOO!";
    note.className = "";
  }
}


//r41v = 0; // wolf dead

// key
//r41w = 0; // 0: not here // 1: on the floor // 2: taken
r41x = () => { // take it
  key.remove();
  s.r41w = 2;
  add_inv("key");
  draw_inv();
}

// boulder
//r41y = 0; // 1 = on the floor
r41z = () => { // take it
  r2099.remove();
  s.r41y = 0;
  add_inv("cannonball");
  draw_inv();
}


// ======================================
// room 4-2: stairs hole


room42 = () => {
  room(0,1,1,1)
  C.p({x:-45,y:-120,z:-50,w:950,h:50,b:"linear-gradient(#333,#555)",rx:145});
  C.p({x:-45,y:235,z:-50,w:950,h:70,b:"linear-gradient(#333,#555)",rx:60});
  wallside(0,0,1);
  C.p({x:-205,y:145,w:500,h:1000,html:svgdoorstair,sx:.16,sy:.16});
  if(s.r42pf) { C.p({x:-175,y:150,z:-40,html:"🚪",css:"door",ry:310}); }
  else {
    C.p({x:-262,y:145,z:10,html:"🚪",css:"door"}); 
    C.p({x:-230,y:140,z:15,html:"🔒",css:"lock",rz:-2,cl:"room42p"});
  }
  C.p({x:-75,y:65,html:"📜",css:"note",sx:1.6,sy:1.6,cl:"r42a"});
  C.p({x:250,y:255,z:-50,html:"🕳️",css:"hole",rz:90,sx:-1,sy:2,cl:"r42d"});
  C.p({x:-325,y:95,z:40,html:"⬅️",css:"arrow",on:"left",cl:"room32"});
  C.p({x:-205,y:95,z:5,html:"⬆️",css:"arrow",on:"up",cl:"room41"});
  C.p({x:50,y:60,html:"🛡️",css:"shield",rz:2});
  C.p({x:80,y:55,html:"🟩️",css:"shape",on:"shield",rz:1});
  if(s.r42b){ C.p({x:180,y:185,z:50,html:"🧀",css:"cheese",sx:-1,cl:"r42e",n:"r421"}); }
  if(s.r42b && !s.r42c) { C.p({x:170,y:185,z:50,html:"🐁",css:"mouse",sx:.4,sy:.4,cl:"r42f",n:"r422"}); }
  else { C.p({x:270,y:185,z:-100,html:"🐁",css:"mouse",sx:.4,sy:.4,cl:"r42f",n:"r422"}); }
  windowright(0);
  draw_sky(0,1);
}

r42a = () => {
  note.className="";
  note.innerHTML = "This tower contains dangerous prisoners";
}

//r42b = 0; // put cheese
//r42c = 0; // take mouse
r42d = () => {
  if(usingstr == "use cheese with ") {
    s.r42b = 1;
    C.p({x:180,y:185,z:50,html:"🧀",css:"cheese",sx:-1,cl:"r42e",n:"r421"});
    rem_inv("cheese");
    use(-1);
    setTimeout(()=> {
      C.m({n:"r422",x:170,z:50});
    },2000);
  }
}

r42e = () => {
  r421.remove();
  add_inv("cheese");
  if(self.r422) C.m({n:"r422",x:270,y:200,z:-100});
  s.r42b = 0;
}

r42f = () => {
  r422.remove();
  add_inv("mouse");
  note.className="";
  note.innerHTML = "I think I saw another mouse hole earlier...";
  s.r42c = 1;
}


// Puzzle

r42pm = [0,0,0,0];
//r42pf = 0; // open

room42p = () => {
  use(-1);
  room(1,0,0,0);
  C.p({x:25,y:0,z:50,w:950,h:650,b:"linear-gradient(#853,#431)"});
  C.p({x:-360,y:-180,z:80,html:"❌",css:"cross",on:"exit",cl:"room42"});
  C.p({x:-220,y:-20,z:50,html:"🔒",css:"big lock",on:"",sx:1.8,sy:1.8});
  C.p({x:-100,y:50,z:55,w:60,h:60,b:["#000","#0F0","#F00","#00F","#FE2"][r42pm[0]],css:"color",on:"",cl:"r42pa",n:"r42p1"});
  C.p({x:-30,y:50,z:55,w:60,h:60,b:["#000","#0F0","#F00","#00F","#FE2"][r42pm[1]],css:"color",on:"",cl:"r42pb",n:"r42p2"});
  C.p({x:40,y:50,z:55,w:60,h:60,b:["#000","#0F0","#F00","#00F","#FE2"][r42pm[2]],css:"color",on:"",cl:"r42pc",n:"r42p3"});
  C.p({x:110,y:50,z:55,w:60,h:60,b:["#000","#0F0","#F00","#00F","#FE2"][r42pm[3]],css:"color",on:"",cl:"r42pd",n:"r42p4"});
}


r42pa = () => {
  r42pm[0] = (r42pm[0]+1) % 5;
  r42pe();
}

r42pb = () => {
  r42pm[1] = (r42pm[1]+1) % 5;
  r42pe();
}

r42pc = () => {
  r42pm[2] = (r42pm[2]+1) % 5;
  r42pe();
}

r42pd = () => {
  r42pm[3] = (r42pm[3]+1) % 5;
  r42pe();
}

r42pe = () => { // draw
  r42p1.style.background = ["#000","#0F0","#F00","#00F","#FE2"][r42pm[0]];
  r42p2.style.background = ["#000","#0F0","#F00","#00F","#FE2"][r42pm[1]];
  r42p3.style.background = ["#000","#0F0","#F00","#00F","#FE2"][r42pm[2]];
  r42p4.style.background = ["#000","#0F0","#F00","#00F","#FE2"][r42pm[3]];
  if(r42pm.join("") == "0241"){
    sound(lock);
    sound(dooropen);
    s.r42pf = 1;
    animation = 1;
    setTimeout(fadeout, 600);
    setTimeout(room42, 1100);
    setTimeout(fadein, 1200);
    setTimeout("animation=0", 1200);
  }
}

// ======================================
// room 4-3: treasure


room43 = () => {
  room(0,1,0,0)
  mount();
  C.p({x:-45,y:-220,z:-50,w:950,h:50,b:"linear-gradient(#333,#555)",rx:145});
  C.p({x:-45,y:235,z:-50,w:950,h:70,b:"linear-gradient(#333,#555)",rx:60});
  if(s.r43c) C.p({x:70,y:145,w:100,h:100,html:svgchestopen,css:"chest",sx:2,sy:2});
  else {
    C.p({x:70,y:145,w:100,h:100,html:svgchest,css:"chest",sx:2,sy:2,cl:"room43p"});
    C.p({x:50,y:140,html:"🔒",css:"lock",rz:-2,cl:"room43p"});
  }
  if(s.r43c && !s.r43d) C.p({x:50,y:110,html:"🪄",css:"wand",rz:30,cl:"r43e",n:"r432"});
  if(!s.r43a) C.p({x:-250,y:185,html:"👑",css:"crown",cl:"r43b",n:"r431"});
  C.p({x:-325,y:95,z:40,html:"⬅️",css:"arrow",on:"left",cl:"room33"});
  wallside(0);
  windowright(1);
  draw_sky(0,1);
}

// Take crown
//r43a = 0; // taken
r43b = () => {
  add_inv("crown");
  r431.remove();
  s.r43a = 1;
}

// Take wand
//r43d = 0; // taken
r43e = () => {
  add_inv("wand");
  r432.remove();
  s.r43d  = 1;
}

//r43c = 0; // chest open

// Puzzle
room43p = () => {
  use(-1);
  r43pm = "";
  r43pa = 0; // angle
  room(1,0,0,0);
  C.p({x:25,y:0,z:50,w:950,h:650,b:"linear-gradient(#853,#642 50%,#000 50%,#000 50.5%,#642 50.5%,#431)"});
  C.p({x:-360,y:-180,z:80,html:"❌",css:"cross",on:"exit",cl:"room43"});
  C.p({x:150,y:50,z:80,html:"↩️",css:"arrow",on:"right",cl:"r43pr"});
  C.p({x:-200,y:50,z:80,html:"↪️",css:"arrow",on:"left",cl:"r43pl"});
  C.p({x:-130,y:20,z:50,html:"🔒",css:"big lock",on:"lock",rz:-2});
  C.p({x:-10,y:100,z:50,w:50,h:50,o:"30px 0px",html:"🐉",css:"dragon",on:"",n:"r43p1",sx:2,sy:2,rz:-2});
}

r43pm = "";
r43pa = 0;

r43pl = () => {
  r43pa -=90;
  r43pm += "l";
  C.m({n:"r43p1",rz:r43pa});
  if(r43pm.endsWith("lrrrrlr")){
    fadeout();
    s.r43c = 1;
    setTimeout("room43();fadein()",500);
  }
}

r43pr = () => {
  r43pa +=90;
  r43pm += "r";
  C.m({n:"r43p1",rz:r43pa});
  if(r43pm.endsWith("lrrrrlr")){
    sound(lock);
    fadeout();
    s.r43c = 1;
    setTimeout("room43();fadein()",500);
  }
}

svgwindow="<svg width=99 height=99 xmlns='http://www.w3.org/2000/svg'><path d='M5 95A35 75 0 0 1 75 95Z' fill='#def' stroke='#555' stroke-width='4'/><path d='M75 95A35 77 0 0 0 33 21A40 89 0 0 1 65 94Z' fill='#777' stroke='#555' stroke-width='4'/></svg>️";

svgwindownight="<svg width=99 height=99 xmlns='http://www.w3.org/2000/svg'><path d='M5 95A35 75 0 0 1 75 95Z' fill='#002' stroke='#555' stroke-width='4'/><path d='M75 95A35 77 0 0 0 33 21A40 89 0 0 1 65 94Z' fill='#777' stroke='#555' stroke-width='4'/></svg>️";

svgbars="<svg width=99 height=99 xmlns='http://www.w3.org/2000/svg'><path d='M25 30L24 95M44 28L45 95' fill='#fff' stroke='#111' stroke-width='8'/></svg>";

svgcannon="<svg width=999 height=999 xmlns='http://www.w3.org/2000/svg'><path d='M900 150L900 360L250 400A150 150 0 0 1 250 100Z' fill='#222' stroke='#000' stroke-width='10'/><circle cx=260 cy=320 r=100 fill='#955' stroke='#000' stroke-width='10'/><path d='M150 130L100 50' stroke='#950' stroke-width='40'/></svg>";

svgdoorstair="<svg width=999 height=999 xmlns='http://www.w3.org/2000/svg'><rect x=50 y=50 width=550 height=900 fill='#222' stroke='#000'/><path d='M50 450L100 450L100 550L50 550L200 550L200 650L50 650L300 650L300 750L50 750L400 750L400 850L50 850L500 850L500 950L50 950Z' fill='#444' stroke='#000' stroke-width='10'/></svg>"

svgdoor="<svg width=99 height=99 xmlns='http://www.w3.org/2000/svg'><rect x=5 y=5 width=55 height=90 fill='#222' stroke='#000'/><path d='M60 5L5 55L5 5Z' fill='#000' stroke='#000'/></svg>"

svghay="<svg width=990 height=990 xmlns='http://www.w3.org/2000/svg'><path d='M400 590L340 630L360 580L310 590L360 540M640 630L700 660L620 670M550 450L590 490L520 490L500 530L480 470M300 720L230 740L270 690M240 540Q490 130 730 540L690 540L760 580L720 580L800 640L750 640L880 780L830 770L900 830L770 800L790 840L630 800L660 830L500 790L490 830L460 790L360 840L390 790L210 850L240 800L90 850L140 800L70 810L170 730L80 750L210 680L140 680L260 570Z' fill='#ff9' stroke='#555' stroke-width='10'/></svg>";

svgwitch="<svg width=999 height=999 xmlns='http://www.w3.org/2000/svg'><path d='M260 330L680 280L530 250L360 0L350 270Z' fill='#a49' stroke='#222' stroke-width='10'/><path d='M520 420L720 530L550 630L500 520L550 630L610 590L690 950L180 940L330 500L290 620L200 550L360 430Z' fill='#a49' stroke='#222' stroke-width='10'/><path d='M360 320L290 410L370 390L360 460L300 510L430 500L520 420L530 300M240 580L200 640L250 670L280 620M620 590L650 670L730 630L660 570Z' fill='#fec' stroke='#222' stroke-width='10'/></svg>";

svganvil="<svg width=99 height=99 xmlns='http://www.w3.org/2000/svg'><path d='M95 0L5 0Q16 15 31 16Q46 25 17 40L17 45L80 45L80 40Q35 21 95 4Z' fill='#111' stroke='#000'/></svg>";

svgchest="<svg width=99 height=99 xmlns='http://www.w3.org/2000/svg'><rect x=10 y=50 width=80 height=40 fill='#853' stroke='#333'/><rect x=10 y=64 width=80 height=13 fill='#853' stroke='#333'/><path d='M10 50Q13 33 25 30L75 30Q90 33 90 50Z' fill='#853' stroke='#333'/></svg>";

svgchestopen="<svg width=99 height=99 xmlns='http://www.w3.org/2000/svg'><rect x=10 y=50 width=80 height=40 fill='#853' stroke='#333'/><rect x=10 y=64 width=80 height=13 fill='#853' stroke='#333'/><path d='M10 50L10 17Q10 8 19 8L79 8Q90 8 90 17L90 50Z' fill='#742' stroke='#333'/></svg>";

svgtable="<svg width=999 height=999 xmlns='http://www.w3.org/2000/svg'><rect x=50 y=500 width=900 height=70 fill='#853' stroke='#222' stroke-width='10'/><rect x=100 y=570 width=50 height=380 fill='#853' stroke='#222' stroke-width='10'/><rect x=850 y=570 width=50 height=380 fill='#853' stroke='#222' stroke-width='10'/><rect x=150 y=570 width=700 height=380 fill='#888' stroke='#222' stroke-width='10'/></svg>"

svgexit="<svg width=999 height=999 xmlns='http://www.w3.org/2000/svg'><path d='M50 950L500 950L500 300Q40 270 50 950' fill='#853' stroke='#333' stroke-width='10'/><circle cx=380 cy=530 r=40 fill='#fe8' stroke='#333' stroke-width='10'/></svg>";

svgknight="<svg width=999 height=999 xmlns='http://www.w3.org/2000/svg'><path d='M240 280L110 340Q160 110 250 280L210 420L120 400L110 330M220 400L280 480L260 720L90 730L120 400M100 720L90 970L210 970L130 930L170 720M250 720L240 910L310 960L200 950L190 720M220 310L200 390M190 330L180 390M160 340L160 390' fill='#999' stroke='#444' stroke-width='10'/><path d='M100 400L150 440L110 550L140 660L70 680L50 540L100 400' fill='#999' stroke='#444' stroke-width='10'/></svg>"

svgtorchsupport="<svg width=99 height=99 xmlns='http://www.w3.org/2000/svg'><rect x=0 y=0 width=31 height=6 fill='#854' stroke='#222'/></svg>";

svgtorch="<svg width=99 height=99 xmlns='http://www.w3.org/2000/svg'><path d='M25 24L14 64L19 66L37 29Z' fill='#854' stroke='#222'/></svg>";

svghanger="<svg width=99 height=99 xmlns='http://www.w3.org/2000/svg'><path d='M34 4L18 6Q14 19 6 9' stroke='#000' fill='#0000' stroke-width='4'/></svg>"

svgplan = "<svg width=99 height=99 xmlns='http://www.w3.org/2000/svg'><path d='M13 38L17 42M16 38L13 42M53 10L49 14M49 10L53 14M83 60L87 64M87 60L83 64M65 82L70 86M69 81L65 86M5 95L95 95L95 5L75 5L75 50L60 50L60 5L40 5L40 50L25 50L25 5L5 5Z' fill='#fff' stroke='#000'/><path d='M22 67L28 62L31 68L28 62L23 99' fill='#fff' stroke='#000'/><text x='85' y='85' font-size='9'>?</text></svg>"

svgrock="<svg width=99 height=99 xmlns='http://www.w3.org/2000/svg'><path d='M4 94L19 94L17 85L9 81L4 88L4 94M17 85L24 73L36 74L35 89L18 91L17 85M35 93L39 85L48 92Z' fill='#ccc' stroke='#222'/></svg>"

svgwolf = "<svg width=999 height=999 xmlns='http://www.w3.org/2000/svg'><path d='M640 270L580 190L480 140L410 90L380 130L410 120L400 150L430 140L420 180L440 160L440 190L470 170L430 210L420 200L420 180L390 180L400 160L370 170L380 130L340 150L340 190L400 250L390 320L310 380L300 470L180 550L140 520L110 550L150 550L90 590L100 640L120 590L150 580L120 630L140 670L150 620L170 590L160 640L180 660L180 620L210 610L220 570L300 520L290 610L180 730L240 870L100 920L120 940L160 930L90 950L120 970L150 950L110 980L140 980L200 960L250 900L290 880L270 830L300 740L290 710L340 680L410 720L380 790L480 850L470 920L500 930L600 980L650 970L590 940L630 960L660 940L610 920L640 930L650 900L520 890L530 760L470 690L530 660L590 690L610 740L570 800L640 750L640 670L560 600L490 620L540 490L660 570L710 640L690 700L730 730L720 690L760 700L780 740L790 680L740 660L790 660L800 700L820 670L780 630L810 640L820 660L820 610L770 610L730 590L700 510L560 380L470 360L510 330L580 330L590 260Z'' fill='#100' stroke='#aaa' stroke-width='10'/></svg>";

svgtri = "<svg width=99 height=99 xmlns='http://www.w3.org/2000/svg'><path d='M10 90L90 90L50 24' fill='#000000'/></svg>";

svgstar = "<svg width=99 height=99 xmlns='http://www.w3.org/2000/svg'><path d='M50 6L80 95L5 35L95 35L15 95Z' fill='#000'/></svg>";

svgcircle = "<svg width=99 height=99 xmlns='http://www.w3.org/2000/svg'><circle cx=50 cy=50 r=45 fill='#000'/></svg>";

svgsquare = "<svg width=99 height=99 xmlns='http://www.w3.org/2000/svg'><rect x=10 y=10 width=80 height=80 fill='#000'/></svg>"

svgkeyhole = "<svg width=99 height=99 xmlns='http://www.w3.org/2000/svg'><path d='M70 90L60 45A19 19 0 1 0 40 45L30 90Z' fill='#000'/></svg>"

svgaxis = "<svg width=99 height=99 xmlns='http://www.w3.org/2000/svg'><circle cx=50 cy=50 r=10 fill='#888' stroke='#000'/></svg>";

svglever = "<svg width=99 height=99 xmlns='http://www.w3.org/2000/svg'><rect x=30 y=0 width=40 height=60 fill='#888' stroke='#000'/><rect x=45 y=10 width=10 height=40 fill='#222'/></svg>"

svgoutside = "<svg width=999 height=999 xmlns='http://www.w3.org/2000/svg'><path d='M50 950A110 150 0 0 1 950 950Z' fill='#4a3' stroke='#444' stroke-width='10'/><path d='M80 950L200 850L800 850L920 950' fill='#444' stroke-width='10'/><path d='M200 850L200 500C350 310 610 260 800 500L800 850Z' fill='#a73' stroke='#444' stroke-width='5'/></svg>"

animation = 0;

// Cannon
anim1 = () => {
  sound(fiou);
  animation = 1;
  room20();
  r2099.style.transformOrigin = "250px 150px";
  r2099.style.transition = ".7s all linear";
  
  setTimeout("C.m({n:'r2099',x:-200,rz:100,z:30})",100);
  
  // Window 2-0 open
  if(s.r20pf){
    setTimeout(room41,800);
    
    
    // Wolf
    if(s.day >= 790 && (s.day % 8) == 4 && s.r40c < 300 && s.r40c > 60 && !s.r41v){
      setTimeout("r2099.style.transition='.5s all';C.m({n:'r2099',x:-155,y:65})",900);
      setTimeout("r2099.style.transition='1s all';C.m({n:'r2099',x:-280,y:185});C.m({n:'ww',x:5,y:165,z:50,rx:65,rz:75,sx:.2,sy:.2})",1410);
      setTimeout("ww.style.opacity=0;s.r41v=1",2000);
      setTimeout("C.m({n:'key',y:0})",2500);
      setTimeout(fadeout,5500);
      setTimeout("s.r41w=s.r41y=1;room01();fadein();animation=0",6000);
    }
    else {
      setTimeout("r2099.style.transition='.5s all';C.m({n:'r2099',x:-80,y:185})",900);
      setTimeout("r2099.style.transition='2s all';C.m({n:'r2099',x:55,y:185})",1410);
      setTimeout(fadeout,5000);
      setTimeout("s.r41y=1;room01();fadein();animation=0",5500);
    }
  }
  
  // 2-0 closed
  else {
    
    setTimeout("r2099.style.transition='.3s all';C.m({n:'r2099',x:-310,y:115,rz:100,z:30})",800);
    setTimeout(fadeout,2500);
    setTimeout("s.r20g=0;room01();fadein();animation=0",3000);
  }
}


// BOOKS
book00 = (i,j) => {
  i=0,j=0;
  sound(paper);
  bookcover.innerHTML = "The big book of inventions";
  bookcover.style.background = `hsl(${(i*5+j*15)*20} 50% ${63}%)`;
  book.innerHTML = "Things invented so far:<br>Castles<br>Cannons<br>Clocks<br>Telescopes<br>Books<br>...<br><br>Coming soon:<br>Electricity<br>Nuclear fission<br>JavaScript<br>..."
  bookcover.className = "";
}

book11 = (i,j) => {
  i=1,j=1;
  sound(paper);
  bookcover.innerHTML = "King's diary";
  bookcover.style.background = `hsl(${(i*5+j*15)*20} 50% ${63}%)`;
  book.innerHTML = "Dear diary,<br><br>Last night the moon was very bright.<br>A wild beast attacked me<br>in the woods.<br>It swallowed the key of my castle.<br>I managed to capture it,<br>but I need to find a way to get<br>my key back...<br><br>Also, my drawbridge mechanism<br>is broken!<br><br>- King Andrzej";
  bookcover.className = "";
}

book20 = (i,j) => {
  i=2,j=0;
  sound(paper);
  bookcover.innerHTML = "How Arthur Became King";
  bookcover.style.background = `hsl(${(i*5+j*15)*20} 50% ${63}%)`;
  book.innerHTML = "Knight Arthur,<br>On the stone saw the sword,<br>Nudged twice up, twice down,<br>And twice on both sides,<br>Making him the king,<br>In the land of Britain."
  bookcover.className = "";
}

book01 = (i,j) => {
  i=0,j=1;
  sound(paper);
  bookcover.innerHTML = "Decoding shields";
  bookcover.style.background = `hsl(${(i*5+j*15)*20} 50% ${63}%)`;
  book.innerHTML = "I've been told that<br>symbols must be read<br>from top to bottom<br>while colors are read<br>from left to right."
  bookcover.className = "";
}


book02 = (i,j) => {
  i=0,j=2;
  sound(paper);
  bookcover.innerHTML = "Map of the castle";
  bookcover.style.background = `hsl(${(i*5+j*15)*20} 50% ${63}%)`;
  book.innerHTML += "<br><br><br><br><br><br><br>Thou are here";
  C.p({g:"book",html:svgplan,x:40,y:-200,sx:1.5,sy:1.5,css:"plan"});
  bookcover.className = "";
}

book13 = (i,j) => {
  i=1,j=3;
  sound(paper);
  bookcover.innerHTML = "The gears of power";
  bookcover.style.background = `hsl(${(i*5+j*15)*20} 50% ${63}%)`;
  book.innerHTML = `I guess they look like this:`
  if(!s.b13b) C.p({g:"book",html:"⚙️",x:10,y:100,css:"gear",cl:"b13a"});
  bookcover.className = "";
}

//b13b = 0;
b13a = () => {
  add_inv("gear");
  s.b13b = 1;
}

book22 = (i,j) => {
  i=2,j=2;
  sound(paper);
  bookcover.innerHTML = "Phases of the moon";
  bookcover.style.background = `hsl(${(i*5+j*15)*20} 50% ${63}%)`;
  book.innerHTML = "In this magical world,<br>a moon cycle is 8 days long.<br><br>🌑 🌒 🌓 🌔 🌕 🌖 🌗 🌘 🌑 <br>new ------------- full ------------ new<br><br>(Actually, it's because there<br>aren't enough moon emoji)"
  bookcover.className = "";
}

book23 = (i,j) => {
  i=2,j=3;
  sound(paper);
  bookcover.innerHTML = "How to turn your dragon"
  bookcover.style.background = `hsl(${(i*5+j*15)*20} 50% ${63}%)`
  C.p({g:"book",w:50,h:50,html:"🐉️",x:50,y:30+30-5,css:"dragon",o:"20px 20px"});
  C.p({g:"book",w:50,h:50,html:"🐉️",x:70,y:30+70-8,rz:-90,css:"dragon",o:"20px 20px"});
  C.p({g:"book",w:50,h:50,html:"🐉️",x:50,y:30+30+110-11,rz:0,css:"dragon",o:"20px 20px"});
  C.p({g:"book",w:50,h:50,html:"🐉️",x:30,y:30+30+150-14,rz:90,css:"dragon",o:"20px 20px"});
  C.p({g:"book",w:50,h:50,html:"🐉️",x:50,y:30+30+190-17,rz:180,css:"dragon",o:"20px 20px"});
  C.p({g:"book",w:50,h:50,html:"🐉️",x:70,y:30+30+60+230-23,rz:270,css:"dragon",o:"20px 20px"});
  C.p({g:"book",w:50,h:50,html:"🐉️",x:50,y:30+30+60+270-26,rz:180,css:"dragon",o:"20px 20px"});
  C.p({g:"book",w:50,h:50,html:"🐉️",x:70,y:30+30+60+350-29,rz:270,css:"dragon",o:"20px 20px"});
  bookcover.className = "";
}

title = () => {
  C.p({w:1100,x:100,y:-100-1050,html:"<h1>CASTLE &nbsp;  &nbsp; ESCAPE"});
  C.p({w:1100,x:100,y:30-1050,html:"<h2>New game",cl:"ng"});
  if(localStorage.castleescape) { 
    C.p({w:1100,x:100,y:85-1050,html:"<h2>Continue",cl:"cg"});
    C.p({w:1100,x:100,y:140-1050,html:"<h2>Bonus",cl:"bs"});
    }
  setTimeout("scene.style.transition='2s all';scene.style.transform='translateY(1000px)translateZ(0)'",500);
}

// new game
ng = () => {
  s = {inv:[],r40c:300,r40d:300,day:801,clicks:0,time:0};
  stop();
  inventory.style.display="block";
  scene.style.transform="translateY(0)";
  setTimeout(()=> {
    room00();
  },550);
  setTimeout(()=> {
    inventory.style.opacity=1;
    mute.style.opacity=1;
    scene.style.transform="";
  },2000);
  draw_inv();
  setInterval("s.time++;save()",1000);
}

// continue game
cg = () => {
  s = JSON.parse(localStorage.castleescape);
  stop();
  inventory.style.display="block";
  scene.style.transform="translateY(0)";
  setTimeout(()=> {
    room00();
  },550);
  setTimeout(()=> {
    inventory.style.opacity=1;
    mute.style.opacity=1;
    scene.style.transform="";
  },2000);
  draw_inv();
  setInterval("s.time++",1000);
}

bs = () => {
  window.open("//xem.github.io/js13k23/bonus");
}


muted = 1;
stop = (A) => {
  muted = 1 - muted;
  mute.innerHTML = ["🔊","🔇"][muted];
  if(muted){
    for(A of acs){ if(A.state != "closed") A.close() }
    clearInterval(AA);
  }
  else {
    song();
    AA=setInterval(song,26670);
  }
}

acs=[];
song = (G,D,i,O,a,s,A) => {
  a=(n,c,d,y,e,I,v,i)=>{
    with(A=new AudioContext){
      acs.push(A);
      with(G=createGain())
        for(i=0;i<n.length;i+=2){
          with(O=createOscillator()){
            connect(G),
            G.connect(destination),
            start(n[i]*I),
            frequency.setValueAtTime(c*1.06**(13-n[i+1]),n[i]*I),
            type="triangle",
            gain.setValueAtTime(v,n[i]*I),
            gain.setTargetAtTime(1e-5,n[i]*I+y,e),
            stop(n[i]*I+d);
          }
       }
    }
  }
  
  a([0,21,4,21,2,14,6,19,10,19,11,17,12,16,16,17,17,19,18,17,21,21,24,21,26,14,28,21,30,19,34,19,35,21,36,23,41,19,42,21,40,21,48,21,48,9,50,14,52,9,54,11,57,12,60,14,62,21,64,14,66,16,69,17,72,17,74,16,76,14,78,11,81,12,84,14,86,17,88,21,90,19,96,21,98,21,101,21,102,21,100,21,108,21,110,21,112,21,113,21,114,21,108,19,110,19,113,19,114,19,112,19,120,21,122,21,124,21,125,21,126,21,120,19,122,19,124,19,125,19,126,19,120,16,122,16,125,16,124,16,126,16,132,21,134,21,136,21,137,21,138,21,132,19,134,19,136,19,138,19,137,19,132,16,136,16,137,16,134,16,138,16,132,14,134,14,136,14,138,14,137,14,144,21,146,21,148,21,149,21,150,21,144,19,146,19,148,19,149,19,150,19,144,16,146,16,148,16,149,16,150,16,144,14,146,14,148,14,149,14,150,14,152,21,152,19,152,16,152,14,154,14,154,16,154,19,154,21,144,11,146,11,148,11,149,11,150,11,152,11,154,11],400,.16,.1,.05,.17,.02);
  a([0,21,4,21,5,21,6,21,9,21,12,21,15,21,16,21,17,21,18,21,21,21,24,21,27,21,28,21,29,21,30,21,33,21,36,21,39,21,40,21,41,21,42,21,45,21,48,21,51,21,52,21,53,21,54,21,57,21,60,21,63,21,64,21,65,21,66,21,69,21,72,21,75,21,76,21,77,21,78,21,81,21,84,21,87,21,88,21,89,21,90,21,93,21,96,21,99,21,100,21,101,21,102,21,105,21,108,21,111,21,112,21,113,21,114,21,117,21,120,21,123,21,124,21,125,21,126,21,129,21,132,21,135,21,137,21,136,21,138,21,141,21,144,21,147,21,148,21,149,21,150,21,153,21,3,21],200,.11,.05,.05,.17,.05);
  a([0,9,12,9,0,14,12,14,24,9,24,14,36,9,36,14,0,2,12,2,36,2,24,2,48,2,48,9,48,14,60,2,60,9,60,14,72,2,72,9,72,14,84,2,84,9,84,14,96,2,96,9,96,14,108,2,108,9,108,14,120,2,120,9,120,14,132,2,132,9,132,14,144,2,144,9,144,14],100,.5,.1,.3,.17,.05)

}

// Sounds

t=(i,n)=>(n-i)/n;

nudge = (i,n,q) =>{
  n=6e3;
  if (i > n) return null;
  q = t(i,n);
  return Math.sin(i*0.01*Math.sin(0.009*i+Math.sin(i/200))+Math.sin(i/100))*q*q/15;
}

lock = (i,n,q) =>{
  n=8e3;
  if (i > n) return null;
  return (((Math.pow(Math.pow(i,0.9)+Math.sin(i*1.06)*1000,0.8)&200)?0.5:-0.5)*Math.pow(t(i,n),1))/2;
}

paper = (i,n,q) =>{
  n=2e4-9000;
  if (i > n) return null;
  q = t(i+10000,n);
  return Math.sin(-i*0.03*Math.sin(0.09*i+Math.sin(i/200))+Math.sin(i/100))*q/15;
}

burn = (i,n,q) =>{
  n=30e4;
  if (i > n) return null;
  q = t(i,n);
  return (Math.sin(-i*0.03*Math.sin(0.09*i+Math.sin(i/200))+Math.sin(i/100))/q/(i>5e4?i/8e3:5))/9;
}

miniburn = (i,n,q) =>{
  n=3e4;
  if (i > n) return null;
  q = t(3e4-i,n);
  return Math.sin(-i*0.03*Math.sin(0.09*i+Math.sin(i/200))+Math.sin(i/100))/q/(i>5e4?i/8e3:5)/15;
}

wand = (i,n,q) =>{
  n=5e4;
  q=1e5;
  if (i > n) return null;
  i=Math.pow(i,1.2-Math.sin(i*2/q))*6;
  return Math.pow(Math.sin(i/30+Math.sin(i/1500)),9)*t(i,n)/9;
}

sword = (i,n,q) =>{
  n=15e3;
  if (i > n) return null;
  q = t(i,n);
  return (Math.sin(i*0.001*Math.sin(0.009*i+Math.sin(i/200))+Math.sin(i/100))*q*q)/9;
}

downbridge = (i,n,q) =>{
  n=60e4;
  if (i > n) return null;
  return (((Math.pow(i+Math.sin(i*0.001)*1000,0.8)&200)?0.5:-0.5)*Math.pow(t(i,n),1))/9;
}

cannonfire = (i,n,q) =>{
  n=4e4;
  if (i > n) return null;
  return (Math.sin(i/200 - Math.sin(i/331)*Math.sin(i/61) + Math.sin(Math.sin(i/59)/39) * 33)*t(i,n)*9)/2;
}

fiou = (i,n,q) =>{
  n=5e4;
  if (i > n) return null;
  q = t(i,n);
  i=i*0.7;
  return (Math.pow(i*50,0.8)&34)?q/9:-q/9;
}

dooropen = (i,n,q) =>{
  n=3e4;
  if (i > n) return null;
  q = t(i,n);
  return Math.sin(i*0.001*Math.sin(0.009*i+Math.sin(i/200))+Math.sin(i/100))*q*q/9;
}

step = (i,n,q) =>{
  n=3800;
  if (i > n) return null;
  q = t(i,n);
  return Math.sin(i*0.01*Math.sin(0.001*i+Math.sin(i/200))+Math.sin(i/200))*q*q/9;
}


// Sound player
sound = (f,sam=96e3,i,m,b,s) => {
  A=new AudioContext()
  m=A.createBuffer(1,sam,48e3)
  b=m.getChannelData(0)
  for(i=sam;i--;)b[i]=f(i)
  s=A.createBufferSource()
  s.buffer=m
  s.connect(A.destination)
  s.start()
}

title()

</script>

<style>
@font-face { font-family: e; src: url(Twemoji.ttf) }
@font-face { font-family: Papyrus; src: url(Papyrus.ttf) }
@keyframes wiggle { 50% { margin-left: -5px } 100% { margin-left: 0 }}
h1,h2 { color: #000; font-family: Papyrus; text-shadow: 0 0 15px #fff; text-align: center; font-size: 40px; cursor: pointer }
h1 { font-size: 60px }
#v{width:1200px;height:540px;overflow:hidden;position:relative;perspective:500px; background: #cde; transition: background 1s; }
#v *{transform-style:preserve-3d;box-sizing:border-box;line-height:0; }
.t * { transition: all .5s;}
* { user-select: none }
.o0 { opacity: 0 }
#inventory { width: 250px; background: #555; height: 100%; position: absolute; right: 0; padding:2px; transition: opacity 5s;}
#inventory div { background: #ccc; width: 115px; height: 81px; margin: 4px; float: left;}
#v .p { font-size: 170px; font-family: e; cursor: pointer; }
svg { pointer-events: none; position: absolute; top: 0;  }
#text { position: absolute; bottom: 10px; left: 0; text-align: center; font: 45px Papyrus, Calibri; color: #fff; text-shadow: 0 0 15px #000, 0 0 5px #000, 0 0 5px #000; width: 960px; pointer-events: none; }
#note { position: absolute; top: 50px; left: 100px; width: 800px; text-align: center; font: 45px Papyrus, Calibri; color: #000; background: #fea; padding: 50px; box-shadow: 0 0 5px #000; }
#camera{width:0;height:0;position:absolute;top:50%;left:480px}
#v .c { border-radius: 50%; border-width:8px; transition: none; }
#v .brick { border: 3px solid #555; pointer-events: none; transition: none;}
#v .door { font-size: 150px; filter: sepia(.5) drop-shadow(0 0 4px #000); }
#v .lock { font-size: 40px; filter: sepia(.5) saturate(.5) drop-shadow(0 0 2px #000) }
#v .lock.big { font-size: 250px; }
#v .chain.big { font-size: 150px; }
#v .chain { font-size: 40px; filter: sepia(.5) drop-shadow(0 0 2px #000) }
#v .bed { filter: sepia(.8) drop-shadow(0 0 4px #000)}
#v .hole { font-size: 40px; }
#v .frame { font-size: 90px; filter: sepia(.9) drop-shadow(0 0 4px #000) }
#v .nofont { font-family: ""; }
#v .framehead { font-size: 30px; filter: sepia(.5); pointer-events:none }
#v .framecrown { font-size: 30px; filter: sepia(.5) drop-shadow(0 0 4px #000); pointer-events:none }
#v .shield { font-size: 100px; filter: sepia(.5) drop-shadow(0 0 4px #000) }
#v .cannonball { font-size: 80px; }
#v .pin { font-size: 30px; }
#v .prisoner { font-size: 170px; filter: sepia(.9) drop-shadow(0 0 4px #000) }
#v .prisoner2 { font-size: 170px; filter: sepia(.7) drop-shadow(0 0 4px #000) }
#v .witch { filter: sepia(.5) drop-shadow(0 0 4px #000) }
#v .telescope { font-size: 150px; filter: sepia(.9) drop-shadow(0 0 4px #000) }
#v .shelf { font-size: 300px; filter: sepia(.6) }
#v .book { border:2px solid #222; filter: sepia(.5) drop-shadow(0 0 1px #000) }
#v .hammer { font-size:70px; filter: sepia(.2) brightness(.35) drop-shadow(0 0 1px #000) }
#v .wood { font-size:70px; filter: sepia(.5) drop-shadow(0 0 1px #000) }
#v .fireplace { font-size:200px; filter: sepia(.2) brightness(.5) drop-shadow(0 0 1px #000) }
#v .fire { font-size:50px; filter: sepia(.2); animation: wiggle .2s infinite; }
#v .skeleton { font-size:50px; filter: saturate(0) }
#v .note { font-size:50px; filter: sepia(.5) brightness(.7) drop-shadow(0 0 1px #000) }
#v .cook { font-size:100px; filter: sepia(.2) drop-shadow(0 0 1px #000) }
#v .cheese { font-size:50px; filter: sepia(.2) drop-shadow(0 0 1px #000) }
#v .soup { font-size:80px; filter: sepia(.2) drop-shadow(0 0 1px #000);transition:opacity 1.5s; }
#v .mouse { font-size: 120px; filter: sepia(.2) drop-shadow(0 0 2px #000); }
#v .soup.hot { font-size:80px; filter: sepia(.2) hue-rotate(293deg) drop-shadow(0 0 1px #000) }
#v .throne { font-size:260px; filter: sepia(.5) saturate(.5) hue-rotate(348deg) drop-shadow(0 0 1px #000) }
#v .rock { font-size:160px; filter: sepia(.5) saturate(.5) drop-shadow(0 0 1px #000) }
#v .bat { font-size:60px; filter: saturate(.5) brightness(.5) drop-shadow(0 0 1px #000) }
#v .sword { font-size:130px; filter: sepia(.5) saturate(.5) hue-rotate(348deg) drop-shadow(0 0 1px #000) }
#v .wand { font-size:60px; filter: sepia(.5) drop-shadow(0 0 1px #000) }
#v .crown { font-size:90px; filter: sepia(.5) drop-shadow(0 0 1px #000) }
#v .arrow { font-size:35px; filter: saturate(.4) drop-shadow(0 0 5px #000) }
#v .sword2 { font-size:200px; filter: saturate(.4) drop-shadow(0 0 5px #000) }
#v .moon { font-size:100px; }
#v .cross { font-size:40px; filter: saturate(.8) drop-shadow(0 0 5px #000) }
#v .gear { font-size:50px; filter: drop-shadow(0 0 2px #000) }
#book .gear { font-size: 130px }
#v .shape { font-size:40px; filter: drop-shadow(0 0 5px #000) }
#v .web { font-size:120px; filter: drop-shadow(0 0 5px #000) }
#v .key { font-size:100px; filter: brightness(2) drop-shadow(0 0 2px #fff) }
#v .shape2 svg { transform:scale(.5);margin:-25px }
#v .color { filter: drop-shadow(0 0 2px #000) }
#v .lever { filter: drop-shadow(0 0 2px #000) }
#v .axis { filter: drop-shadow(0 0 2px #000) }
#v .dragon { font-size:50px; }
#sun, .sunwrapper { pointer-events: none }
.h { display: none }
#inventory div .p { background: none; font-size: 60px !important; font-family: e;  }
#inventory div .telescope { filter: sepia(.9) brightness(.6) !important }
#inventory div .key { filter: brightness(2) drop-shadow(0 0 1px #000) }
#bookcover { width: 350px; height: 490px; background: #cba ; margin: 25px 0 0 250px; box-shadow: 0 0 5px #000; text-align: center; font: 45px Papyrus, Calibri; color: #000; padding: 20px;}
#book { width: 820px; height: 490px; background: linear-gradient(90deg, #fed 48%, #876 50%, #fed 52%); margin: 28px 0 0 45px; border:10px solid #555; box-shadow: 0 0 5px #000; font: 25px/30px Papyrus, Calibri; color: #000; padding: 10px;}
.mount { border-radius: 50%; pointer-events: none }
#fo { position: absolute; top: 0; left: 0; width: 950px; height: 540px; pointer-events: none; background: #000; transition: opacity .5s } 
.wheel { background: radial-gradient(#854 20%,#222 22%, #0000 24%), linear-gradient(#cde 45%, #002 55%) !important; border: 2px solid #854; outline: 3px solid #222;  }
.base { border: 3px solid #222; }
#v .timewheel * { font: 30px e } 
#skygroup { transition: 1s all; }
#db { transition: all 10s }
#mute { font-family: e; position: absolute; right: 260px; top: 35px; font-size: 40px; transition: opacity 5s; cursor: pointer; filter: drop-shadow(0 0 5px #000) }
.sun, .moon { pointer-events: none }
#v .egg { font: 30px Papyrus; padding: 10px }